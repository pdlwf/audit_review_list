<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>R&D Capability Assessment – 研发能力审核（含雷达图）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif;margin:24px;color:#111}
  h1,h2{margin:0 0 12px}
  .desc{color:#555;margin-bottom:18px}
  .grid{display:grid;gap:18px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #eee;padding:10px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  .mod-head{display:flex;justify-content:space-between;align-items:center}
  .badge{background:#eef6ff;color:#0366d6;border:1px solid #cfe3ff;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill{padding:2px 8px;border-radius:8px;background:#f6f6f6;border:1px solid #eaeaea;font-size:12px;color:#444}
  select.scorebox{min-width:280px}
  .notes{width:100%}
  .footer{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .legend{font-size:12px;color:#555}
  .muted{color:#777}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi > div{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;text-align:center}
  .ok{color:#0a7a34}
  .warn{color:#b45309}
  .risk{color:#b91c1c}
  .stickybar{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:10px 0;margin:-10px 0 14px}
  .btn{cursor:pointer;border:1px solid #ddd;background:#fff;border-radius:8px;padding:8px 12px}
  .btn:hover{background:#f6f6f6}
  details.rubric{margin-top:6px;font-size:12px}
  details.rubric summary{cursor:pointer;color:#0366d6}
  details.rubric ul{margin:6px 0 0 18px;padding:0;list-style:disc}
  details.rubric li{margin-bottom:4px}
  #hovercard{position:fixed;z-index:9999;max-width:420px;background:#111;color:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px 14px;font-size:13px;line-height:1.5;display:none}
  #hovercard h5{margin:6px 0 4px;font-size:12px;color:#a7c7ff}
  #hovercard ul{margin:0 0 6px 16px;padding:0}
  #hovercard[aria-hidden="false"]{display:block}
</style>
</head>
<body>
  <div class="stickybar footer">
    <button class="btn" onclick="resetScores()">清空分数</button>
    <button class="btn" onclick="exportJSON()">导出 JSON</button>
    <span class="legend">评分尺度：1 无系统｜2 非正式｜3 有文件并执行｜4 有效运行且闭环｜5 自动化数据驱动</span>
  </div>

  <h1>研发能力审核 R&D Capability Assessment</h1>
  <p class="desc">目标：确认供应商从产品定义、设计、验证到制造导入全链路内建质量与可靠性，风险受控、供应可得、测试覆盖充分，并以数据驱动持续改进。</p>

  <div id="modules" class="grid"></div>

  <div id="hovercard" role="tooltip" aria-hidden="true"></div>

  <div class="card">
    <h2>汇总与雷达图</h2>
    <div class="kpi" id="kpi"></div>
    <canvas id="radar" height="180"></canvas>
    <p class="muted">提示：各模块得分为该模块问题的<strong>平均分</strong>（满分 5）。建议门槛：<span class="ok">≥4.0</span> 合格；<span class="warn">3.0–3.9</span> 需整改计划；<span class="risk">&lt;3.0</span> 高风险。</p>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
/** 模块与问题定义（根据 revise.md 同步结构与口径） **/
// 元信息模板，按问题关键词生成默认关注点/问法/证据/门槛
const META_TEMPLATES = {
  general:{
    focus:["确认流程、职责与证据链闭环"],
    ask:["当前机制如何运行？有哪些量化指标？"],
    evidence:["制度文件或台账","执行记录与例会纪要"],
    threshold:["形成文件化机制并可持续复用"]
  },
  orgBoundary:{
    focus:["组织架构与岗位说明书是否发布","跨团队接口人和升级路径是否明确","职责边界与权限如何维护"],
    ask:["组织架构多长时间更新一次？","跨团队升级路径和 SLA 如何定义？"],
    evidence:["最新组织架构图与岗位说明","接口/升级流程记录"],
    threshold:["组织职责发布并可查询","升级路径在项目中可验证"]
  },
  competency:{
    focus:["关键岗位胜任力模型覆盖度","认证/培训闭环","能力缺口与资源备份计划"],
    ask:["胜任力矩阵包含哪些岗位？","培训与认证记录如何管理？"],
    evidence:["胜任力矩阵与更新记录","培训/认证计划与考试结果"],
    threshold:["关键岗位均建立胜任力要求","能力缺口形成行动并跟踪"]
  },
  driList:{
    focus:["子系统 DRI 清单准确性","权限与备份机制","变更同步与覆盖缺口"],
    ask:["DRI 清单如何维护和发布？","变更时如何确认 DRI 覆盖？"],
    evidence:["DRI 名单与权限说明","变更同步或排班记录"],
    threshold:["关键子系统均指定 DRI","缺口补位有记录并闭环"]
  },
  governance:{
    focus:["DRB/CCB 章程与议题管理","Stop-Build 建议权与执行","技术决策与指标挂钩"],
    ask:["DRB/CCB 多久召开一次？","Stop-Build 建议如何触发与闭环？"],
    evidence:["DRB/CCB 议程与纪要","风险或指标触发记录"],
    threshold:["技术治理例会常态化","决策与整改均有审计记录"]
  },
  npiFlow:{
    focus:["端到端流程阶段与交付物","角色职责与门禁判定","流程执行记录与复盘"],
    ask:["NPI 流程的关键 Gate 是哪些？","Entry/Exit 判定如何落地？"],
    evidence:["流程文档/流程图","阶段评审纪要与交付物清单"],
    threshold:["端到端流程文件化并执行","关键 Gate 结果可追溯"]
  },
  designSpec:{
    focus:["设计规范覆盖领域","版本管理与发布机制","培训与稽核联动"],
    ask:["规范如何归档与受控？","版本更新如何通知到项目？"],
    evidence:["规范清单/版本记录","培训签到或稽核报告"],
    threshold:["关键设计规范受控且及时更新"]
  },
  externalChange:{
    focus:["客户/法规输入感知机制","影响评估与责任划分","实施与验证闭环"],
    ask:["外部输入如何捕获并派发？","影响评估包含哪些维度？"],
    evidence:["外部输入台账","评估与落实计划"],
    threshold:["关键外部输入均评估并形成验证计划"]
  },
  esd:{
    focus:["TVS 选型与夹持电压","回流路径与接地策略","接口目标 ESD/Surge 等级","Latch-up 与带电插拔风险"],
    ask:["目标 ESD/Surge 等级是多少？","关键接口的 TVS BOM 与布局如何验证？","是否进行带电插拔/EFT/Latch-up 预验证？"],
    evidence:["IEC 61000-4-2 预验证记录","JESD78 Latch-up 报告","接口布局截图与器件曲线"],
    threshold:["接触放电≥8kV，空气放电≥15kV","异常失效注入通过且无复位"]
  },
  wcca:{
    focus:["环路补偿相位/增益裕量","上/下电时序与跨轨约束","器件容差/温漂/WCCA 分析","失效注入与充放电安全"],
    ask:["Bode 实测数据如何？","WCCA 覆盖哪些回路？","上/下电时序如何验证？"],
    evidence:["Bode 图与测量记录","WCCA 报告与 Worst-Case 表","上/下电时序波形与限值"],
    threshold:["相位裕量≥45°，增益裕量≥6 dB","关键轨超限闭环并记录"]
  },
  pdn:{
    focus:["PDN 目标阻抗设定","去耦电容网络与布局回路","高速接口眼图/BER 余量","仿真与板测一致性"],
    ask:["Ztarget 如何定义与验证？","仿真与板测差异如何评估？"],
    evidence:["PDN 仿真模型与结果","示波/VNA 测量记录","眼图或 BER 报告"],
    threshold:["关键频段阻抗满足目标并留余量","高速接口通过协议限值"]
  },
  structure:{
    focus:["跌落/扭转/点载 CAE 与实测闭环","螺钉/卡扣/胶粘疲劳","密封公差链与透气策略","盐雾/汗液等耐蚀风险"],
    ask:["CAE 如何与实测比对？","密封公差链如何计算？"],
    evidence:["FEA 模型与校核报告","跌落/扭转/密封测试数据"],
    threshold:["1.5m 六面多次功能正常","IP 目标与耐蚀要求达成"]
  },
  thermal:{
    focus:["稳态+瞬态 CFD 模型","测温点校准与偏差控制","散热材料与节流策略","关键场景功耗输入"],
    ask:["仿真实测偏差控制在多少？","节流策略触发点如何设定？"],
    evidence:["CFD 报告与边界条件","温升测试表","节流/降额曲线"],
    threshold:["触感温度满足目标","结温低于器件上限","充电热稳定验证通过"]
  },
  rf:{
    focus:["3D EM 与整机耦合分析","TRP/TIS 预算与余量","结构变更触发复核","SAR/一致性评估"],
    ask:["仿真与 OTA 数据如何对齐？","多姿态 OTA 结果是否满足？"],
    evidence:["EM 仿真报告","VNA/OTA 测试数据","相关性比对记录"],
    threshold:["关键频段余量满足预算并留裕量"]
  },
  camera:{
    focus:["MTF/SFR、OECF、畸变等全科目","OIS/AF 寿命验证","设备校准与 GR&R","报告追溯性"],
    ask:["测试方法是否对标 ISO？","设备校准如何维护？"],
    evidence:["完整相机实验室报告","原始数据与曲线","校准证书或 GR&R"],
    threshold:["全科目覆盖且数据可追溯","与 ORT/场景数据闭环"]
  },
  specialSim:{
    focus:["DFMEA 触发条件与台账","专项仿真模型与参数库","仿真-实测闭环","风险复核策略"],
    ask:["DFMEA 高风险如何触发专项仿真？","模型如何校准与版本化？"],
    evidence:["专项仿真报告与模型文件","验证对比记录"],
    threshold:["高风险项均建立仿真验证闭环"]
  },
  testMatrix:{
    focus:["功能/性能/可靠性覆盖矩阵","Entry/Exit 与停线规则","缺口识别与整改计划"],
    ask:["矩阵如何维护并与项目联动？","Entry/Exit 判定依据是什么？"],
    evidence:["测试矩阵或 coverage 报告","异常整改台账"],
    threshold:["关键场景覆盖率达成且缺口闭环"]
  },
  labCapability:{
    focus:["关键实验室/仪器配置","校准与资质维护","外部实验室评估","产能与排期"],
    ask:["仪器校准周期如何管理？","外部实验室资质如何评估？"],
    evidence:["仪器清单与校准记录","实验室资质或委外合同"],
    threshold:["关键试验能力满足项目需求","产能/排期可量化管理"]
  },
  envLife:{
    focus:["环境/寿命测试矩阵","应力条件与判据","寿命模型与数据回写"],
    ask:["ALT/循环测试覆盖哪些工况？","寿命模型如何建立并校准？"],
    evidence:["环境/寿命测试报告","寿命模型或拟合曲线"],
    threshold:["关键环境应力测试完成并通过","寿命模型与实测数据闭环"]
  },
  dfm:{
    focus:["跨部门 DFM/DFA 评审机制","问题清单与整改闭环","制造约束纳入设计基线"],
    ask:["评审参与角色有哪些？","整改闭环如何追踪？"],
    evidence:["DFM/DFA 评审纪要","整改清单与验证记录"],
    threshold:["关键可制造风险闭环并有复盘"]
  },
  esi:{
    focus:["供应商早期参与范围","产能/交期/生命周期评估","输入纳入设计约束"],
    ask:["ESI 包含哪些关键评估？","评估结果如何反馈给设计？"],
    evidence:["供应商评估报告","约束清单与行动计划"],
    threshold:["产能/生命周期评估完成并落实约束"]
  },
  dualSource:{
    focus:["关键物料二供策略","等效性验证覆盖功能/可靠性","切换流程与风险控制"],
    ask:["二供验证包含哪些测试？","切换判据如何设定？"],
    evidence:["二供验证报告","可靠性/一致性数据"],
    threshold:["关键物料二供通过验证并备案"]
  },
  tooling:{
    focus:["工装/治具/ICT/FCT 需求定义","验收标准与调试","培训与维护计划"],
    ask:["验收标准如何量化？","试产前如何确认产能与稳定性？"],
    evidence:["工装需求与验收记录","调试/培训纪要"],
    threshold:["关键工装在试产前完成验收并具备量产能力"]
  },
  changeProcess:{
    focus:["ECR→ECN 流程","影响评估维度","验证计划与实施跟踪"],
    ask:["影响评估包含哪些输入？","ECN 实施状态如何追踪？"],
    evidence:["ECR/ECN 台账","影响评估与验证记录"],
    threshold:["所有变更均完成影响评估与验证闭环"]
  },
  plm:{
    focus:["PLM/ALM 单一数据源","权限与版本控制","变更同步机制"],
    ask:["资料如何纳入 PLM/ALM？","权限与版本如何审批？"],
    evidence:["系统截图或配置说明","权限矩阵与操作记录"],
    threshold:["关键数据在系统中受控且版本可追溯"]
  },
  traceability:{
    focus:["样机/批次与版本对应关系","Where Used/As-built 数据","追溯查询效率"],
    ask:["如何快速定位受影响样机？","数据是否实时更新？"],
    evidence:["追溯系统截图","查询记录与响应时间"],
    threshold:["样机与版本双向追溯可在系统中完成"]
  },
  pcn:{
    focus:["PCN/SCN 通知流程","责任人与时限","影响评估与应对"],
    ask:["通知流程如何触发？","如何确认对方已收到并执行？"],
    evidence:["PCN/SCN 台账","影响评估与应对计划"],
    threshold:["关键通知留痕并可审计"]
  },
  riskRegister:{
    focus:["风险分类与台账","Impact×Probability 量化","责任人与更新频率"],
    ask:["风险等级如何计算？","更新频率是多少？"],
    evidence:["风险台账或系统截图","更新记录与缓解计划"],
    threshold:["重大风险均量化并指定责任人","状态更新可追溯"]
  },
  contingency:{
    focus:["Plan B/C 触发条件","演练与资源准备","降级策略与沟通机制"],
    ask:["关键风险的应急方案有哪些？","演练与资源如何记录？"],
    evidence:["Plan B/C 文档","演练记录或资源清单"],
    threshold:["高风险均具备演练过的替代方案"]
  },
  kpi:{
    focus:["研发 KPI 指标体系","数据采集与可视化","指标驱动改进机制"],
    ask:["关键 KPI 如何计算？","指标异常如何触发行动？"],
    evidence:["KPI 看板或报表","指标分析与改进行动"],
    threshold:["核心 KPI 常态化监控并驱动改进"]
  },
  lessons:{
    focus:["项目复盘节奏与范围","知识沉淀与标准回写","复用提醒与成效衡量"],
    ask:["复盘输出如何归档？","回写标准后如何验证执行？"],
    evidence:["复盘/LL 文档","回写标准与跟踪记录"],
    threshold:["复盘成果沉淀并在项目中复用"]
  }
};

// 统一生成问题元信息（默认模板）
function applyTemplate(meta, name){
  const tpl = META_TEMPLATES[name];
  if(!tpl) return;
  ['focus','ask','evidence','threshold'].forEach(key=>{
    tpl[key].forEach(item=>{
      if(item && !meta[key].includes(item)) meta[key].push(item);
    });
  });
}

function stripHTML(str){
  return (str || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
}

function normalizeKey(str){
  return stripHTML(str).replace(/[\s`*_~!@#$%^&()+=\-：:；;，,。！？?、<>【】\[\]]/g,'').toLowerCase();
}

function defaultMeta(modKey, text){
  const meta={focus:[],ask:[],evidence:[],threshold:[]};
  const plain = stripHTML(text);
  const lower = plain.toLowerCase();
  const applied = new Set();
  const run = name=>{applyTemplate(meta,name);applied.add(name);};
  if(/esd|浪涌|surge|tvs|充电口/i.test(plain)) run('esd');
  if(/wcca|电源|环路|bode|时序|充电|放电/.test(plain)) run('wcca');
  if(/pdn|si-?pi|眼图|高速|mipi|usb|ddr/.test(lower)) run('pdn');
  if(/结构|冲击|跌落|密封|fea|ip/.test(plain)) run('structure');
  if(/热|cfd|温升|节流|vc|石墨片/.test(plain)) run('thermal');
  if(/射频|天线|ota|sar|trp|tis|rf/.test(lower)) run('rf');
  if(/相机|mtf|sfr|oecf|ois|af/.test(lower)) run('camera');
  if(/矩阵|entry|exit/.test(lower)) run('testMatrix');
  if(/实验室|仪器|暗室/.test(plain)) run('labCapability');
  if(/环境|寿命|alt|高低温|盐雾|汗液/.test(plain)) run('envLife');
  if(/dfm|dfa/.test(lower)) run('dfm');
  if(/供应商|esi|产能|交期|生命周期/.test(plain)) run('esi');
  if(/二供|替代/.test(plain)) run('dualSource');
  if(/工装|治具|ict|fct/.test(lower)) run('tooling');
  if(/ecr|ecn|变更/.test(lower)) run('changeProcess');
  if(/plm|alm|bom|图纸|固件/.test(lower)) run('plm');
  if(/追溯|whereused|asbuilt|样机|批次/.test(lower)) run('traceability');
  if(/pcn|scn|通知/.test(lower)) run('pcn');
  if(/风险台账|impact|probability/.test(lower)) run('riskRegister');
  if(/planb|plan c|替代方案|降级策略/.test(lower)) run('contingency');
  if(/胜任力|能力|矩阵/.test(plain)) run('competency');
  if(/组织|职责|边界/.test(plain)) run('orgBoundary');
  if(/dri/.test(lower)) run('driList');
  if(/治理|决策|drb|ccb|stop-build/.test(lower)) run('governance');
  if(/npi|流程|里程碑/.test(lower)) run('npiFlow');
  if(/规范|标准|设计规范/.test(plain)) run('designSpec');
  if(/外部输入|客户|法规|pcn/.test(lower)) run('externalChange');
  if(/kpi/.test(lower)) run('kpi');
  if(/复盘|lessons learned|ll/.test(lower)) run('lessons');
  if(/仿真|dfmea|专项/.test(plain)) run('specialSim');
  if(applied.size===0) run('general');
  ['focus','ask','evidence','threshold'].forEach(key=>{
    if(!meta[key].length) meta[key] = [...META_TEMPLATES.general[key]];
  });
  return meta;
}

function decorateModel(){
  MODEL.forEach(module=>{
    module.questions.forEach((q,idx)=>{
      q.meta = defaultMeta(module.key, q.text);
      q._normKey = normalizeKey(q.text);
      q._index = idx;
    });
  });
}

// 从 revise.md 解析 meta
function applyReviseMeta(markdown){
  const lines = markdown.split(/\r?\n/);
  const thresholds = {};
  let inThreshold = false;
  lines.forEach(line=>{
    if(/^###\s+📏\s*门槛/.test(line)) { inThreshold = true; return; }
    if(inThreshold){
      if(/^#/.test(line) || /^---/.test(line)) { inThreshold = false; return; }
      const trimmed = line.trim();
      if(trimmed.startsWith('- ')){
        const body = trimmed.slice(2).trim();
        const parts = body.split(/[:：]/);
        if(parts.length>=2){
          thresholds[parts[0].trim()] = parts.slice(1).join('：').trim();
        }
      } else if(trimmed===''){ inThreshold = false; }
    }
  });

  const designSections = {};
  let currentKey = null;
  lines.forEach(line=>{
    const trimmed = line.trim();
    const sectionMatch = trimmed.match(/^####\s*(3\.\d)\s*(.*)$/);
    if(sectionMatch){
      currentKey = sectionMatch[1];
      designSections[currentKey] = [];
      return;
    }
    if(currentKey){
      if(/^####/.test(trimmed) || /^###/.test(trimmed) || /^##/.test(trimmed) || /^---/.test(trimmed)){
        currentKey = null;
        return;
      }
      if(trimmed.startsWith('- ')){
        designSections[currentKey].push(trimmed.slice(2).trim());
      }
    }
  });

  const detailSections = [];
  let currentQuestion = null;
  let capture = null;
  lines.forEach(line=>{
    const trimmed = line.trim();
    if(/^---$/.test(trimmed)){ currentQuestion=null; capture=null; return; }
    if(/^\-\s*\*\*(.+)\*\*$/.test(trimmed)){
      const qText = trimmed.replace(/^\-\s*\*\*/, '').replace(/\*\*$/, '').trim();
      currentQuestion = qText;
      capture = null;
      detailSections.push({question:qText,norm:normalizeKey(qText),evidence:[]});
      return;
    }
    if(currentQuestion){
      if(/^\*\*(.+)\*\*$/.test(trimmed)){
        const heading = trimmed.replace(/\*\*/g,'');
        if(/期望证据/.test(heading)){
          capture = 'evidence';
        } else {
          capture = null;
        }
        return;
      }
      if(trimmed.startsWith('- ') && capture==='evidence'){
        const target = detailSections[detailSections.length-1];
        target.evidence.push(trimmed.slice(2).trim());
        return;
      }
      if(trimmed.startsWith('**打分口径')){ capture=null; }
    }
  });

  const thresholdMap = {
    '3.1': thresholds['ESD 预验证'],
    '3.2': thresholds['Bode'],
    '3.3': thresholds['PDN'],
    '3.4': thresholds['跌落'],
    '3.5': thresholds['热'],
    '3.6': thresholds['RF']
  };

  const designModule = MODEL.find(m=>m.key==='design');
  if(designModule){
    designModule.questions.forEach(q=>{
      const tagMatch = q.text.match(/【(3\.\d)/);
      const tag = tagMatch?tagMatch[1]:null;
      if(tag && designSections[tag]){
        const bullets = designSections[tag];
        const focusLines = [];
        let evidenceLine = '';
        bullets.forEach(item=>{
          const clean = item.replace(/[`*_]/g,'').trim();
          const parts = clean.split(/[:：]/);
          if(parts.length>=2){
            const label = parts[0].trim();
            const rest = parts.slice(1).join('：').trim();
            if(/证据/.test(label)){
              evidenceLine = rest;
            } else {
              focusLines.push(`${label}：${rest}`);
            }
          } else if(clean){
            focusLines.push(clean);
          }
        });
        if(focusLines.length) q.meta.focus = focusLines;
        if(evidenceLine){
          const evidArr = evidenceLine.split(/[、；;，]/).map(s=>s.trim()).filter(Boolean);
          if(evidArr.length) q.meta.evidence = evidArr;
        }
      }
      if(tag && thresholdMap[tag]){
        const thArr = thresholdMap[tag].split(/[；;]/).map(s=>s.trim()).filter(Boolean);
        if(thArr.length) q.meta.threshold = thArr;
      }
    });
  }

  const verifyModule = MODEL.find(m=>m.key==='verify');
  if(verifyModule && detailSections.length){
    verifyModule.questions.forEach(q=>{
      const target = detailSections.find(item=>q._normKey.includes(item.norm) || item.norm.includes(q._normKey));
      if(target && target.evidence.length){
        q.meta.evidence = target.evidence.map(txt=>txt.replace(/[`*_]/g,'').trim()).filter(Boolean);
      }
    });
  }
}

const MODEL = [
  {
    key:"org",
    name:"1. 研发组织与资源",
    intent:"确认组织健全、职责清晰、胜任力与培训体系完善",
    questions:[
      {
        text:`<strong>#1 组织边界与职责清晰度（R&R、跨团队接口）</strong><br>是否有正式组织架构、跨团队接口定义与升级路径？`,
        rubric:{
          "1":"无正式组织架构或职责描述，跨团队接口依赖个人沟通。",
          "2":"有组织图但R&R模糊，接口人或升级路径缺乏记录。",
          "3":"形成书面R&R并发布，跨团队接口与职责有基本定义。",
          "4":"跨团队接口SLA、升级机制与例会例行执行，职责边界清晰落地。",
          "5":"基于项目复盘动态优化R&R，接口绩效与资源数据化可追踪。"
        }
      },
      {
        text:`<strong>#2 关键岗位胜任力矩阵（RF/Camera/EMC/热/可靠性）</strong><br>关键岗位是否具备胜任力矩阵与资格认证？`,
        rubric:{
          "1":"无胜任力矩阵或岗位胜任标准，人员能力不可视。",
          "2":"有零散胜任力记录但未覆盖关键岗位或缺更新。",
          "3":"建立胜任力矩阵并定义资格标准，具备考核记录。",
          "4":"定期评审矩阵并联动培训/考证，能力缺口有闭环计划。",
          "5":"胜任力矩阵与项目需求/资源排期联动，预警能力缺口并沉淀数据。"
        }
      },
      {
        text:`<strong>#4 领域覆盖与 DRI 清单（子系统命名 DRI、权限）</strong><br>是否维护子系统 DRI 清单及权限边界？`,
        rubric:{
          "1":"无 DRI 清单或仅口头指定，领域覆盖情况不透明。",
          "2":"存在初步 DRI 名单但权限、职责或备份安排不清晰。",
          "3":"维护正式 DRI 清单并定义权限范围，项目可查询到负责人。",
          "4":"DRI 清单与项目/变更动态同步，覆盖缺口及时补位。",
          "5":"DRI 清单与资源看板/排班系统集成，能力负荷与权限变更可追踪。"
        }
      },
      {
        text:`<strong>#5 技术治理与决策边界（DRB/CCB、Stop-Build 建议权）</strong><br>技术治理机制是否有效运行？`,
        rubric:{
          "1":"无技术治理例会或决策机制，重大变更随意决策。",
          "2":"偶尔召开 DRB/CCB，但议题、参与人和结论缺章程。",
          "3":"DRB/CCB 有章程与决策记录，Stop-Build 建议有依据。",
          "4":"技术治理决策与风险、度量挂钩，可触发停线与整改闭环。",
          "5":"技术治理体系数据化运行，决策与指标、知识库形成闭环。"
        }
      }
    ]
  },
  {
    key:"process",
    name:"2. 研发流程与标准（NPI/IPD）",
    intent:"确认端到端流程文件化并与合规/客户标准对齐",
    questions:[
      {
        text:"是否有端到端 NPI 流程（需求→架构→设计→验证→移交），并落实职责分工？",
        rubric:{
          "1":"无端到端 NPI 流程，节点靠经验推进。",
          "2":"有流程框架但未纳入标准里程碑与角色责任。",
          "3":"端到端 NPI 流程已文档化，关键里程碑与交付物有规定。",
          "4":"流程结合跨部门评审与门禁，执行状态有记录与复盘。",
          "5":"流程与项目管理系统集成，指标与风险自动监控。"
        }
      },
      {
        text:"是否建立研发设计规范库（PCB、ESD、射频、结构等）并保持版本可追溯？",
        rubric:{
          "1":"无统一设计规范，依赖个人经验。",
          "2":"有零散规范或旧版本，缺更新机制。",
          "3":"关键领域建立受控的设计规范并发布。",
          "4":"规范定期评审并关联培训/检查表，执行有记录。",
          "5":"规范与工具链/DRC 联动，变更自动通知并追踪执行。"
        }
      },
      {
        text:"对外部输入（客户/法规/PCN）是否建立变更感知与落地机制？",
        rubric:{
          "1":"无外部输入跟踪机制，信息靠个人传达。",
          "2":"能接收外部输入但缺评估与落实记录。",
          "3":"建立外部输入台账并指定责任人跟进落实。",
          "4":"变更评估流程覆盖影响分析与验证计划，闭环可审计。",
          "5":"外部输入与需求/配置系统联动，落地状态可视化与预警。"
        }
      }
    ]
  },
  {
    key:"design",
    name:"3. 设计质量与可靠性（含前期物料选型与准入）",
    intent:"确认设计阶段内建可靠性与可制造性，并以规范与证据闭环",
    questions:[
      {
        text:`【3.1 静电/浪涌与系统级保护（ESD/Surge）】<ul><li>规范：ESD/Surge 设计指南（器件/布局/接地/回流）</li><li>保护：接口 TVS/滤波/共模扼流 BOM（USB-C/SIM/天线/显示/按键）</li><li>预验证：IEC 61000-4-2 目标等级记录；Latch-up/JEDEC 测试</li><li>充电口：OVP/OCP/OTP；带电插拔/EFT 场景</li><li>证据：器件选型表、布局截图、预验证报告</li></ul>`,
        rubric:{
          "1":"无 ESD/Surge 设计规范，依赖个人经验处理接口保护。",
          "2":"有零散 ESD/Surge 经历但缺统一器件 BOM 与记录。",
          "3":"形成 ESD/Surge 规范并完成关键接口预验证与等级记录。",
          "4":"器件、布局、预验证闭环稳定，充电口保护与 Latch-up 测试达标。",
          "5":"自动化 DRC 与器件库维护，变更触发复核并持续跟踪相关性。"
        }
      },
      {
        text:`【3.2 电源完整性与 WCCA（Worst-Case）】<ul><li>稳定性：环路补偿 Bode（相位/增益裕量）</li><li>时序：上/下电时序波形与限制</li><li>容差：关键电源链路 WCCA/器件偏差/温漂/老化</li><li>安全：充电/放电失效注入（短路/探头脱落/冲击）</li><li>证据：电源树、Bode/时序实测、WCCA 报告、失效注入记录</li></ul>`,
        rubric:{
          "1":"无电源稳定性或 WCCA 分析，依赖样机试错。",
          "2":"零散测量缺少 Bode 或容差分析，文档不完整。",
          "3":"具备 Bode 测试并对关键节点进行容差与限值评估。",
          "4":"完成完整 WCCA 报告并覆盖失效注入与充放电安全验证。",
          "5":"电源模型化并与仿真/实测阈值联动，变更自动触发复核。"
        }
      },
      {
        text:`【3.3 PDN / SI-PI 联合仿真】<ul><li>目标：PDN 目标阻抗（频域/时域）</li><li>去耦：电容网络方案与布局回路</li><li>高速：MIPI/USB/DDR 眼图/BER 报告</li><li>一致性：仿真 vs 板上测量对比</li><li>证据：PDN 仿真/测量、眼图、去耦清单</li></ul>`,
        rubric:{
          "1":"无 PDN 目标阻抗或 SI-PI 仿真，去耦方案凭经验。",
          "2":"仅经验摆放电容，缺少量化指标或仿真记录。",
          "3":"制定 PDN 目标并开展仿真与眼图分析。",
          "4":"仿真与板上测量一致，去耦与眼图报告形成闭环。",
          "5":"持续监控版本间相关性，PDN 目标与变更复核联动。"
        }
      },
      {
        text:`【3.4 结构应力 / 冲击 / 密封（FEA & IP）】<ul><li>FEA：跌落/扭转/点载 CAE 与实测闭环</li><li>连接：螺钉/卡扣/胶粘结构强度与疲劳</li><li>IP：密封胶圈压缩量、公差链；透气件布置</li><li>耐蚀：汗液/盐雾风险点</li><li>证据：CAE 模型/校核、跌落&扭转实测、IP 型式测试</li></ul>`,
        rubric:{
          "1":"仅做零散结构实测，无 CAE 或标准支撑。",
          "2":"尚未建立系统 CAE 模型，评估多依赖经验。",
          "3":"能执行 CAE 或实测其一，覆盖主要跌落/扭转/IP 场景。",
          "4":"CAE 与实测互相校验，IP 型式与耐蚀测试达到目标。",
          "5":"建立参数库与公差链分析，结构/密封变更自动触发复核。"
        }
      },
      {
        text:`【3.5 热设计与电-热协同（CFD）】<ul><li>工况：拍摄/5G/游戏/充电 场景功耗</li><li>仿真：稳态+瞬态 CFD；测温点对比</li><li>方案：石墨片/VC/TIM；节流策略曲线</li><li>降额：热致降额与寿命</li><li>证据：CFD 报告、测温表、节流策略</li></ul>`,
        rubric:{
          "1":"无热设计仿真或节流策略，依靠经验排布。",
          "2":"仅有稳态仿真或零散测温，缺少校准基准。",
          "3":"完成稳态仿真并进行关键点测温校核。",
          "4":"稳态与瞬态 CFD 与实测偏差受控，节流与降额策略闭环。",
          "5":"电热耦合模型与寿命评估联动，热点监控与策略自动更新。"
        }
      },
      {
        text:`【3.6 射频/天线仿真与 OTA 预算】<ul><li>EM：3D 天线/整机仿真（FEM/FDTD）</li><li>余量：效率/带宽/匹配容差；MIMO 相关性</li><li>影响：结构件/屏蔽/地弹片变更复核</li><li>合规：SAR 初评</li><li>证据：EM 仿真、VNA/OTA 实测、变更评估单</li></ul>`,
        rubric:{
          "1":"仅关注 S11 等基础匹配，无 OTA 预算或仿真。",
          "2":"零散开展 3D EM 或 OTA 其中一项，缺系统预算。",
          "3":"具备 3D EM 仿真或 OTA 测试，并对效率/匹配进行评估。",
          "4":"EM 与 OTA 数据一致性可证明，余量与结构变更有复核。",
          "5":"建立余量预算与变更触发机制，持续监控 MIMO/SAR 数据闭环。"
        }
      },
      {
        text:`【3.7 条件触发的必要仿真（按 DFMEA 高风险触发）】<ul><li>公差链 Monte-Carlo（贴合/光轴/密封/卡扣）</li><li>相机专项（MTF/SFR、OIS/AF 寿命）</li><li>声学/振动（腔体、Mic、NVH）</li><li>EMC 预分析（谐振/屏蔽/滤波）</li><li>电池模型（循环寿命、极耳温升热点）</li></ul>`,
        rubric:{
          "1":"无条件触发仿真策略，DFMEA 高风险未覆盖。",
          "2":"仅零散执行个别专项仿真，缺触发标准与记录。",
          "3":"依据 DFMEA 触发主要专项仿真，但闭环与验证不完全。",
          "4":"触发条件、仿真与验证闭环形成台账，可追溯至项目风险。",
          "5":"仿真模型与参数库维护完备，与变更/风险阈值联动自动复核。"
        }
      }
    ]
  },
  {
    key:"verify",
    name:"4. 实验验证与测试能力",
    intent:"确认具备研发阶段验证手段与场景覆盖，且与目标/准则闭环",
    questions:[
      {
        text:"是否建立覆盖功能/性能/可靠性/合规的测试矩阵，并与 Entry/Exit 对齐？",
        rubric:{
          "1":"无测试矩阵，测试科目依赖经验安排。",
          "2":"按经验挑选测试科目，矩阵覆盖与门槛未定义。",
          "3":"建立测试矩阵并列出覆盖项，但 Entry/Exit 或判定阈值未完全对齐。",
          "4":"测试矩阵与 Entry/Exit、停线规则对齐，异常有闭环机制。",
          "5":"测试数据回写到规则库，矩阵覆盖率与缺口动态维护。"
        }
      },
      {
        text:"是否具备关键实验室/仪器（EMC/安规/ESD/热像/相机 SFR/射频）或合格外部实验室？",
        rubric:{
          "1":"缺乏关键实验室或仪器，能力无法满足需求。",
          "2":"部分仪器具备但校准或资质缺失，外部资源无评估。",
          "3":"关键实验室或外部资质明确，仪器清单与校准记录可追溯。",
          "4":"仪器能力与维护计划闭环，产能与排期满足项目需求。",
          "5":"实验室能力指标化管理，容量与质量数据驱动资源规划。"
        }
      },
      {
        text:"是否开展环境与寿命测试（ALT/高低温循环/高湿/盐雾/汗液），并建立寿命预测模型？",
        rubric:{
          "1":"无环境或寿命测试计划，风险未识别。",
          "2":"零散开展环境或寿命测试，缺方法与记录。",
          "3":"执行 ALT/高低温/盐雾等测试，并保留数据与判定标准。",
          "4":"建立寿命预测模型，与测试数据比对闭环并形成改进。",
          "5":"寿命模型与量产监控联动，数据驱动策略调整与预警。"
        }
      },
      {
        text:"RF/OTA 暗室是否能完成 TRP/TIS 测试？仿真与实测的相关性如何证明？",
        rubric:{
          "1":"无 OTA 能力或无报告",
          "2":"有测试记录，方法/校准/相关性缺失",
          "3":"可完成 TRP/TIS，相关性有初步对比",
          "4":"方法规范，相关性阈值明确且稳定达标",
          "5":"常态化相关性监控与模型回归；结构变更触发复核"
        }
      },
      {
        text:"相机实验室是否能出具 MTF/SFR、OECF、畸变、杂散光、OIS/AF 寿命完整报告？",
        rubric:{
          "1":"无相机实验能力或无报告",
          "2":"科目零散，缺方法与校准",
          "3":"主要科目可出具，方法/校准基本合规",
          "4":"全科目覆盖，数据可追溯、稳定复现",
          "5":"与量产 ORT/场景数据闭环（趋势/漂移监控与规则回写）"
        }
      }
    ]
  },
  {
    key:"scm",
    name:"5. 研发与供应链协同（DFM/DFA/早期导入）",
    intent:"确认设计阶段即考虑可制造性、可装配性与可得性，二供与工装同步",
    questions:[
      {
        text:"是否进行跨部门 DFM/DFA 评审（RD/ME/PE/QA/SCM），并确保结论整改闭环？",
        rubric:{
          "1":"未开展跨部门 DFM/DFA 评审，设计制造冲突未识别。",
          "2":"偶尔召开评审但参会部门不全，整改缺乏记录。",
          "3":"建立跨部门评审并形成整改清单，部分闭环。",
          "4":"评审结论按责任闭环并追踪验证，工艺约束纳入设计基线。",
          "5":"DFM/DFA 评审数据化沉淀，问题趋势与经验库驱动设计优化。"
        }
      },
      {
        text:"早期供应商参与（ESI）：产能/交期/生命周期/替代评估是否纳入设计约束？",
        rubric:{
          "1":"无早期供应商参与，设计阶段缺供方输入。",
          "2":"仅在样机阶段邀请供应商，产能或交期评估缺失。",
          "3":"制定 ESI 计划，涵盖产能、交期与生命周期评估。",
          "4":"供应商评估结果纳入设计约束，措施闭环并有记录。",
          "5":"ESI 数据与项目计划联动，供应能力变化实时预警。"
        }
      },
      {
        text:"关键物料二供策略是否在设计阶段完成等效性验证（功能/可靠性/一致性）？",
        rubric:{
          "1":"无二供策略或仅口头约定。",
          "2":"识别潜在二供但未验证等效性。",
          "3":"关键物料二供完成功能验证并记录。",
          "4":"二供验证覆盖可靠性与一致性，切换流程明确。",
          "5":"二供能力纳入风险矩阵，量产状态持续监控与回写。"
        }
      },
      {
        text:"试产前工装/治具/ICT/FCT 需求与验收标准是否明确并完成验收？",
        rubric:{
          "1":"试产前工装/治具需求未识别或无标准。",
          "2":"有工装需求但验收标准缺失，交付常延误。",
          "3":"工装/ICT/FCT 需求明确定义并完成基本验收。",
          "4":"验收标准量化且闭环，试产前完成调试与培训。",
          "5":"工装状态数字化管理，与试产/量产良率数据联动。"
        }
      }
    ]
  },
  {
    key:"change",
    name:"6. 变更与配置管理（ECN/BOM/版本）",
    intent:"确认研发变更受控、版本与样机/批次可双向追溯",
    questions:[
      {
        text:"需求/设计变更是否执行 ECR→ECN 流程并进行成本/进度/质量影响评估？",
        rubric:{
          "1":"无正式 ECR/ECN 流程，变更记录缺失。",
          "2":"有流程但执行零散，影响评估模板不完整。",
          "3":"ECR→ECN 流程运行，影响评估与审批记录完整。",
          "4":"评估结论与验证计划闭环，实施状态可追溯。",
          "5":"变更流程与项目系统集成，影响数据实时分析与预警。"
        }
      },
      {
        text:"BOM/图纸/固件是否在 PLM/ALM 中实现单一数据源与权限控制？",
        rubric:{
          "1":"BOM/图纸/固件分散管理，缺乏权限控制。",
          "2":"部分资料入库但版本控制不一致。",
          "3":"在 PLM/ALM 中维护单一数据源并设定权限。",
          "4":"版本更替有审批轨迹，与制造/供应链同步。",
          "5":"数据主线与配置管理系统打通，自动同步并可审计。"
        }
      },
      {
        text:"样机/批次与版本是否可双向追溯（Where Used/As-built）？",
        rubric:{
          "1":"样机或批次无法追溯所用版本。",
          "2":"存在零散追溯记录，查询效率低。",
          "3":"建立双向追溯台账，可关联主要样机与版本。",
          "4":"追溯信息实时更新，支持快速定位影响范围。",
          "5":"追溯系统可视化，支持逆向分析与批量预警。"
        }
      },
      {
        text:"对客户/生产/供应商的 PCN/SCN 通知机制是否明确且可审计？",
        rubric:{
          "1":"无 PCN/SCN 通知机制，沟通多靠口头。",
          "2":"有通知流程但责任与时限不明确。",
          "3":"建立通知流程与记录，能对关键方进行确认。",
          "4":"通知包含影响评估与应对计划，全链路可追溯。",
          "5":"通知流程数字化，与供应商/客户系统对接并自动提醒。"
        }
      }
    ]
  },
  {
    key:"risk",
    name:"7. 风险管控（技术/进度/合规）",
    intent:"确认从立项起持续识别、量化并处置风险，设置缓冲与熔断机制",
    questions:[
      {
        text:"是否建立项目风险台账（技术/供应/合规/资源），并对风险进行 Impact×Probability 量化？",
        rubric:{
          "1":"无项目风险台账，风险靠经验沟通。",
          "2":"有风险清单但未量化 Impact×Probability。",
          "3":"建立风险台账并量化 Impact×Probability，指定责任人。",
          "4":"风险状态定期更新，缓解计划执行可追溯。",
          "5":"风险台账与项目指标联动，支持预警与决策。"
        }
      },
      {
        text:"是否为关键风险建立 Plan B/C（替代方案/降级策略/二供切换）并有演练记录？",
        rubric:{
          "1":"无应急或替代方案。",
          "2":"有口头 Plan B/C，但无演练与记录。",
          "3":"关键风险制定 Plan B/C 并形成文档。",
          "4":"替代方案有演练与资源准备，切换标准明确。",
          "5":"Plan B/C 与监控指标联动，可快速触发并复盘优化。"
        }
      }
    ]
  },
  {
    key:"perf",
    name:"8. 研发绩效与持续改进",
    intent:"确认以数据驱动提升效率与质量，客户反馈闭环到设计",
    questions:[
      {
        text:"是否设定并跟踪研发 KPI（一期通过率/缺陷密度/按期率/返工率/RMA/ppm）？",
        rubric:{
          "1":"无研发 KPI 或仅口头关注。",
          "2":"有 KPI 指标但数据收集不完整。",
          "3":"KPI 定期统计并通报，用于项目评估。",
          "4":"KPI 结合目标对比与根因分析，推动改进。",
          "5":"KPI 数据实时可视化，与激励/改进机制闭环。"
        }
      },
      {
        text:"是否开展项目复盘/LL（Lessons Learned）并沉淀为设计与工艺标准？",
        rubric:{
          "1":"无项目复盘或经验沉淀机制。",
          "2":"零散复盘，输出未标准化。",
          "3":"定期开展复盘并形成 Lessons Learned 文档。",
          "4":"复盘结论转化为规范/检查表并跟踪落实。",
          "5":"LL 库与项目流程结合，自动提醒复用并衡量成效。"
        }
      }
    ]
  }
];

decorateModel();
fetch('revise/revise.md')
  .then(res=>res.ok?res.text():Promise.reject())
  .then(text=>applyReviseMeta(text))
  .catch(()=>{});

// Build a single <option> using rubric text for level n; fallback to generic label if missing
function optionHtml(n, text){
  const FALLBACK = {
    1: '1 无系统',
    2: '2 非正式',
    3: '3 有文件并执行',
    4: '4 有效运行且闭环',
    5: '5 自动化数据驱动'
  };
  const label = text ? `${n} ${text}` : FALLBACK[n];
  // title attribute helps show full text on hover if select text is truncated
  return `<option value="${n}" title="${text ? (n + ' ' + text) : FALLBACK[n]}">${label}</option>`;
}

// Render a scorebox for module key + question index, pulling per-question rubric first
function renderScorebox(modKey, qIndex){
  const module = MODEL.find(m => m.key === modKey);
  const q = module && module.questions ? module.questions[qIndex] : null;                 // q can be a string or an object {text, rubric, meta...}
  const rubric = (q && q.rubric)
              || (window.RUBRICS && RUBRICS[modKey] && RUBRICS[modKey][qIndex])
              || null;

  return `
    <select class="scorebox" data-module="${modKey}" data-index="${qIndex}" onchange="recalc()">
      <option value="">—</option>
      ${[1,2,3,4,5].map(n => optionHtml(n, rubric ? rubric[String(n)] : null)).join('')}
    </select>
  `;
}

/** 动态渲染清单 **/
const host = document.getElementById('modules');
MODEL.forEach((m, mi) => {
  const card = document.createElement('div');
  card.className='card';
  card.innerHTML = `
    <div class="mod-head">
      <h2>${m.name}</h2>
      <span class="badge" title="${m.intent}">目的：${m.intent}</span>
    </div>
    <table>
      <thead><tr><th style="width:44px">#</th><th>问题（Questions）</th><th style="width:110px">得分(1-5)</th><th>证据/备注</th></tr></thead>
      <tbody>
        ${m.questions.map((q, qi) => `
          <tr>
            <td>${qi+1}</td>
            <td class="qtext" data-module="${m.key}" data-index="${qi}" tabindex="0">
              <div>${q.text}</div>
              <details class="rubric"><summary>查看打分口径</summary>
                <ul>
                  ${['1','2','3','4','5'].map(level => `<li><b>${level}分：</b>${q.rubric[level]}</li>`).join('')}
                </ul>
              </details>
            </td>
            <td class="score-cell">
              ${renderScorebox(m.key, qi)}
            </td>
            <td><input class="notes" placeholder="证据/链接/记录编号（如：DFMEA#2025-03, DRR纪要, TVS选型表 等）"/></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div class="footer">
      <span class="pill">模块均分：<b id="avg-${m.key}">—</b></span>
      <span class="muted">（空白项不计入均分）</span>
    </div>
  `;
  host.appendChild(card);
});

/** 汇总与雷达图 **/
const kpiBox = document.getElementById('kpi');
function kpiCell(lbl, val){
  const color = (val>=4)?'ok':(val>=3?'warn':'risk');
  return `<div><div class="muted">${lbl}</div><div class="${color}" style="font-size:20px;font-weight:700">${isNaN(val)?'—':val.toFixed(2)}</div></div>`;
}

const ctx = document.getElementById('radar').getContext('2d');
const radar = new Chart(ctx,{
  type:'radar',
  data:{
    labels: MODEL.map(m=>m.name.replace(/^\d+\.\s*/,'')),
    datasets:[{
      label:'模块得分',
      data: new Array(MODEL.length).fill(0),
      fill:true,
      borderWidth:2,
      pointRadius:3
    }]
  },
  options:{
    responsive:true,
    scales:{ r:{ min:0, max:5, ticks:{stepSize:1} } },
    plugins:{ legend:{display:false} }
  }
});

function getMeta(modKey, idx){
  const fallback = { focus:['暂无'], ask:['暂无'], evidence:['暂无'], threshold:['暂无'] };
  const module = MODEL.find(m=>m.key===modKey);
  const question = module && module.questions[idx];
  if(!question) return fallback;
  const meta = question.meta || fallback;
  const pick = key => (Array.isArray(meta[key]) && meta[key].length) ? meta[key] : fallback[key];
  return {
    focus: pick('focus'),
    ask: pick('ask'),
    evidence: pick('evidence'),
    threshold: pick('threshold')
  };
}

function renderHover(meta){
  const build = (title, data) => {
    const list = Array.isArray(data) ? data : [data];
    return `<h5>${title}</h5><ul>` + list.map(item=>`<li>${item}</li>`).join('') + '</ul>';
  };
  return build('关注点', meta.focus) + build('怎么问', meta.ask) + build('期望证据', meta.evidence) + build('建议门槛', meta.threshold);
}

// 悬浮提示卡逻辑
function bindHovercard(){
  const card = document.getElementById('hovercard');
  if(!card) return;
  const cells = document.querySelectorAll('td.qtext');
  let current = null;

  const hideCard = () => {
    card.setAttribute('aria-hidden','true');
    current = null;
  };

  const placeCard = ev => {
    if(!ev) return;
    const pad = 12;
    let x = ev.clientX + pad;
    let y = ev.clientY + pad;
    const rect = card.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    if(x + rect.width > vw - 8) x = Math.max(8, vw - rect.width - 8);
    if(y + rect.height > vh - 8) y = Math.max(8, vh - rect.height - 8);
    card.style.left = `${Math.max(8, x)}px`;
    card.style.top = `${Math.max(8, y)}px`;
  };

  cells.forEach(td=>{
    td.addEventListener('mouseenter', ev=>{
      const meta = getMeta(td.dataset.module, Number(td.dataset.index));
      card.innerHTML = renderHover(meta);
      card.setAttribute('aria-hidden','false');
      placeCard(ev);
      current = td;
    });
    td.addEventListener('mousemove', placeCard);
    td.addEventListener('mouseleave', hideCard);
    td.addEventListener('focus', ()=>{
      const meta = getMeta(td.dataset.module, Number(td.dataset.index));
      card.innerHTML = renderHover(meta);
      card.setAttribute('aria-hidden','false');
      const bounds = td.getBoundingClientRect();
      let x = bounds.right + 8;
      let y = bounds.bottom + 8;
      const rect = card.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      if(x + rect.width > vw - 8) x = Math.max(8, vw - rect.width - 8);
      if(y + rect.height > vh - 8) y = Math.max(8, vh - rect.height - 8);
      card.style.left = `${Math.max(8, x)}px`;
      card.style.top = `${Math.max(8, y)}px`;
      current = td;
    });
    td.addEventListener('blur', hideCard);
  });

  document.addEventListener('keydown', e=>{
    if(e.key === 'Escape'){
      hideCard();
    }
  });
  window.addEventListener('scroll', hideCard, { passive:true });
  window.addEventListener('resize', hideCard);
}

function recalc(){
  const avgs=[];
  MODEL.forEach((m, idx)=>{
    const selects=[...document.querySelectorAll(`select[data-module="${m.key}"]`)];
    const nums=selects.map(s=>Number(s.value)).filter(v=>!isNaN(v) && v>0);
    const avg = nums.length? nums.reduce((a,b)=>a+b,0)/nums.length : NaN;
    document.getElementById(`avg-${m.key}`).textContent = isNaN(avg)?'—':avg.toFixed(2);
    avgs[idx]= isNaN(avg)? 0 : Number(avg.toFixed(2));
  });
  // 更新雷达
  radar.data.datasets[0].data = avgs.map(v=>v||0);
  radar.update();

  // KPI 概览
  const overall = avgs.filter(v=>v>0).length? (avgs.reduce((a,b)=>a+b,0)/avgs.filter(v=>v>0).length) : NaN;
  kpiBox.innerHTML =
    kpiCell('总体均分', overall) +
    MODEL.map((m,i)=>kpiCell(m.name.split(' ')[0], avgs[i]||NaN)).join('');
}
recalc();
bindHovercard();

function resetScores(){
  document.querySelectorAll('select.scorebox').forEach(s=>s.value="");
  document.querySelectorAll('input.notes').forEach(n=>n.value="");
  recalc();
}
function exportJSON(){
  const payload = { modules: [] };
  MODEL.forEach(m=>{
    // 导出时同步题目文本与逐级打分口径，确保数据闭环
    const moduleDef = MODEL.find(mm=>mm.key===m.key);
    const rows=[...document.querySelectorAll(`select[data-module="${m.key}"]`)].map((s,idx)=>{
      const tr = s.closest('tr');
      const qObj = moduleDef && moduleDef.questions ? moduleDef.questions[idx] : null;
      const meta = (qObj && qObj.meta) || {};
      const rubric = (qObj && qObj.rubric)
                  || (window.RUBRICS && RUBRICS[m.key] && RUBRICS[m.key][idx])
                  || null;
      return {
        q: (qObj && qObj.text) ? qObj.text : qObj,
        score: Number(s.value||0),
        note: tr.querySelector('input.notes').value||"",
        rubric: rubric,
        meta:{
          focus: Array.isArray(meta.focus)?[...meta.focus]:[],
          ask: Array.isArray(meta.ask)?[...meta.ask]:[],
          evidence: Array.isArray(meta.evidence)?[...meta.evidence]:[],
          threshold: Array.isArray(meta.threshold)?[...meta.threshold]:[]
        }
      };
    });
    const scores=rows.map(r=>r.score).filter(v=>v>0);
    const avg = scores.length? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
    payload.modules.push({ key:m.key, name:m.name, intent:m.intent, avg: Number(avg.toFixed(2)), rows });
  });
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "rd_capability_assessment.json";
  a.click();
}
</script>
</body>
</html>
