<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>R&D Capability Assessment – 研发能力审核（含雷达图）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif;margin:24px;color:#111}
  h1,h2{margin:0 0 12px}
  .desc{color:#555;margin-bottom:18px}
  .header-bar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .grid{display:grid;gap:18px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #eee;padding:10px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  .mod-head{display:flex;justify-content:space-between;align-items:center}
  .badge{background:#eef6ff;color:#0366d6;border:1px solid #cfe3ff;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill{padding:2px 8px;border-radius:8px;background:#f6f6f6;border:1px solid #eaeaea;font-size:12px;color:#444}
  select.scorebox{min-width:280px}
  .notes{width:100%}
  .footer{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .legend{font-size:12px;color:#555}
  .muted{color:#777}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi > div{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;text-align:center}
  .ok{color:#0a7a34}
  .warn{color:#b45309}
  .risk{color:#b91c1c}
  .stickybar{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:10px 0;margin:-10px 0 14px}
  .btn{cursor:pointer;border:1px solid #ddd;background:#fff;border-radius:8px;padding:8px 12px}
  .btn:hover{background:#f6f6f6}
  #hovercard{position:fixed;z-index:9999;max-width:420px;background:#111;color:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px 14px;font-size:13px;line-height:1.5;display:none}
  #hovercard h5{margin:6px 0 4px;font-size:12px;color:#a7c7ff}
  #hovercard ul{margin:0 0 6px 16px;padding:0}
  #hovercard[aria-hidden="false"]{display:block}
</style>
</head>
<body>
  <div class="stickybar footer">
    <button class="btn" id="clearBtn" type="button"></button>
    <button class="btn" id="exportBtn" type="button"></button>
    <span class="legend" id="scaleLegend"></span>
  </div>

  <div class="header-bar">
    <h1 id="pageTitle"></h1>
    <button id="langToggle" class="btn" type="button" aria-label="toggle language"></button>
  </div>
  <p class="desc" id="pageDesc"></p>

  <div id="modules" class="grid"></div>

  <div id="hovercard" role="tooltip" aria-hidden="true"></div>

  <div class="card">
    <h2 id="summaryTitle"></h2>
    <div class="kpi" id="kpi"></div>
    <canvas id="radar" height="180"></canvas>
    <p class="muted" id="summaryTip"></p>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
const MODULE_KEYS = ["org","process","design","verify","scm","change","risk","perf"];
const DATA_DIR = "./data";
const moduleAverages = new Map();
let MODEL = [];
let radar = null;
let UI_I18N = {};
window.UI_I18N = UI_I18N;
const LANGS = ["zh","en"];
const DRAFT_KEY = "audit.draft.v1";
const RUBRIC_FALLBACK = {
  zh: {
    "1": "无系统",
    "2": "非正式",
    "3": "有文件并执行",
    "4": "有效运行且闭环",
    "5": "自动化数据驱动"
  },
  en: {
    "1": "No system",
    "2": "Informal",
    "3": "Documented & executed",
    "4": "Effective & closed-loop",
    "5": "Automated & data-driven"
  }
};
let HOVER_EVENTS_BOUND = false;

function escapeHtml(str) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
  return String(str ?? "").replace(/[&<>"']/g, ch => map[ch]);
}
function escapeAttr(str){
  return escapeHtml(str);
}
function slugify(s){
  return String(s || "")
    .replace(/<\/?[^>]+>/g, "")
    .replace(/[^\w一-龥]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-|-$|_/g, "")
    .toLowerCase();
}

function ensureLangObject(value){
  if(value && typeof value === "object" && !Array.isArray(value)){
    const zh = typeof value.zh === "string" ? value.zh.trim() : "";
    const en = typeof value.en === "string" ? value.en.trim() : "";
    const fallback = zh || en || "";
    return { zh: zh || fallback, en: en || fallback };
  }
  if(typeof value === "string"){
    const trimmed = value.trim();
    return { zh: trimmed, en: trimmed };
  }
  return { zh: "", en: "" };
}

function normalizeRubricLang(source, lang){
  const fallback = RUBRIC_FALLBACK[lang];
  const base = (source && typeof source === "object" && !Array.isArray(source)) ? source : {};
  const result = {};
  for(let i = 1; i <= 5; i++){
    const key = String(i);
    const raw = base[key];
    const text = typeof raw === "string" && raw.trim() ? raw.trim() : fallback[key];
    result[key] = text;
  }
  return result;
}

function normalizeMetaLang(source, lang){
  const fallbackText = lang === "en" ? "(None)" : "（暂无）";
  const base = (source && typeof source === "object" && !Array.isArray(source)) ? source : {};
  const result = {};
  ["focus","ask","evidence","threshold"].forEach(key => {
    const raw = base[key];
    const arr = Array.isArray(raw) ? raw : (raw != null ? [raw] : []);
    const cleaned = arr.map(item => {
      if(typeof item === "string") return item.trim();
      if(item == null) return "";
      return String(item).trim();
    }).filter(item => item && item !== "（暂无条目）");
    result[key] = cleaned.length ? Array.from(new Set(cleaned)) : [fallbackText];
  });
  return result;
}

function getLang(){
  const saved = localStorage.getItem("audit.lang");
  if(saved && LANGS.includes(saved)) return saved;
  const nav = (navigator.language || navigator.userLanguage || "zh").toLowerCase();
  return nav.startsWith("zh") ? "zh" : "en";
}
function setLang(l){
  if(LANGS.includes(l)){
    localStorage.setItem("audit.lang", l);
  }
}

function tUI(key){
  const lang = window.CUR_LANG || "zh";
  if(UI_I18N && UI_I18N[lang] && UI_I18N[lang][key] != null){
    return UI_I18N[lang][key];
  }
  if(UI_I18N && UI_I18N.zh && UI_I18N.zh[key] != null){
    return UI_I18N.zh[key];
  }
  return key;
}
function tName(module){
  if(!module) return "";
  const lang = window.CUR_LANG || "zh";
  const name = module.name;
  if(typeof name === "string") return name;
  if(name && typeof name === "object"){
    return name[lang] || name.zh || "";
  }
  return module.key || "";
}
function tIntent(module){
  if(!module) return "";
  const lang = window.CUR_LANG || "zh";
  const intent = module.intent;
  if(typeof intent === "string") return intent;
  if(intent && typeof intent === "object"){
    return intent[lang] || intent.zh || "";
  }
  return "";
}
function tText(question){
  if(!question) return "";
  const lang = window.CUR_LANG || "zh";
  const text = question.text;
  if(typeof text === "string") return text;
  if(text && typeof text === "object"){
    return text[lang] || text.zh || "";
  }
  return "";
}
function tRubric(question){
  const lang = window.CUR_LANG || "zh";
  const rb = question && question.rubric;
  if(rb){
    if(rb[lang]) return rb[lang];
    if(rb.zh) return rb.zh;
    return rb;
  }
  return null;
}
function tMeta(question){
  const lang = window.CUR_LANG || "zh";
  const meta = question && question.meta;
  if(meta){
    if(meta[lang]) return meta[lang];
    if(meta.zh) return meta.zh;
    return meta;
  }
  return { focus: [], ask: [], evidence: [], threshold: [] };
}

function readDraft(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch (err){
    return {};
  }
}
function writeDraft(d){
  localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
}
function saveField(modKey, qId, field, value){
  if(!modKey || !qId) return;
  const draft = readDraft();
  draft.lang = window.CUR_LANG || "zh";
  draft.modules = draft.modules || {};
  const moduleDraft = draft.modules[modKey] || (draft.modules[modKey] = {});
  const record = moduleDraft[qId] || (moduleDraft[qId] = {});
  const isEmpty = value === null || value === undefined || value === "" || (typeof value === "string" && value.trim() === "");
  if(isEmpty){
    delete record[field];
  } else {
    record[field] = value;
  }
  if(Object.keys(record).length === 0){
    delete moduleDraft[qId];
  }
  if(Object.keys(moduleDraft).length === 0){
    delete draft.modules[modKey];
  }
  writeDraft(draft);
}
function applyDraft(draft){
  if(!draft || !draft.modules) return;
  Object.entries(draft.modules).forEach(([modKey, questions]) => {
    const selects = Array.from(document.querySelectorAll(`select.scorebox[data-module="${modKey}"]`));
    const notes = Array.from(document.querySelectorAll(`input.notes[data-module="${modKey}"]`));
    Object.entries(questions || {}).forEach(([qid, rec]) => {
      if(rec && typeof rec === "object"){
        if(rec.score !== null && rec.score !== undefined && rec.score !== ""){
          selects.forEach(sel => {
            if(sel.dataset.qid === qid){
              sel.value = String(rec.score);
            }
          });
        }
        if(rec.note !== null && rec.note !== undefined){
          notes.forEach(input => {
            if(input.dataset.qid === qid){
              input.value = String(rec.note);
            }
          });
        }
      }
    });
  });
}

function ensureQuestionShape(modKey, q, idx){
  const question = (q && typeof q === "object" && !Array.isArray(q)) ? { ...q } : {};
  question.text = ensureLangObject(question.text !== undefined ? question.text : q);
  if(!question.id || typeof question.id !== "string" || !question.id.trim()){
    const baseText = question.text.zh || question.text.en || `q${(idx || 0) + 1}`;
    const base = slugify(baseText).slice(0, 60) || `q${(idx || 0) + 1}`;
    question.id = `${modKey}-${base}`;
  }
  const rawRubric = question.rubric;
  const zhRubric = normalizeRubricLang(rawRubric && rawRubric.zh ? rawRubric.zh : rawRubric, "zh");
  let enRubric;
  if(rawRubric && rawRubric.en){
    enRubric = normalizeRubricLang(rawRubric.en, "en");
    for(let i = 1; i <= 5; i++){
      const key = String(i);
      if(!enRubric[key]){
        enRubric[key] = zhRubric[key] || RUBRIC_FALLBACK.en[key];
      }
    }
  } else {
    enRubric = { ...zhRubric };
  }
  question.rubric = { zh: zhRubric, en: enRubric };

  const rawMeta = question.meta;
  const zhMeta = normalizeMetaLang(rawMeta && rawMeta.zh ? rawMeta.zh : rawMeta, "zh");
  let enMeta;
  if(rawMeta && rawMeta.en){
    enMeta = normalizeMetaLang(rawMeta.en, "en");
    ["focus","ask","evidence","threshold"].forEach(key => {
      if(!Array.isArray(enMeta[key]) || enMeta[key].length === 0){
        enMeta[key] = zhMeta[key].slice();
      }
    });
  } else {
    enMeta = {
      focus: zhMeta.focus.slice(),
      ask: zhMeta.ask.slice(),
      evidence: zhMeta.evidence.slice(),
      threshold: zhMeta.threshold.slice()
    };
  }
  question.meta = { zh: zhMeta, en: enMeta };
  return question;
}

function optionHtml(n, text){
  const fallbackMap = RUBRIC_FALLBACK[window.CUR_LANG === "en" ? "en" : "zh"];
  const fallbackLabel = `${n} ${fallbackMap[String(n)]}`;
  const raw = text && String(text).trim() ? `${n} ${text}` : fallbackLabel;
  const safe = escapeHtml(raw);
  return `<option value="${n}" title="${safe}">${safe}</option>`;
}

function renderScorebox(modKey, idx){
  const module = MODEL.find(m => m.key === modKey);
  const question = module && module.questions ? module.questions[idx] : null;
  const rubric = question ? tRubric(question) : null;
  const qId = question ? question.id : "";
  const options = [1,2,3,4,5].map(n => optionHtml(n, rubric ? rubric[String(n)] : null)).join("");
  return `
    <select class="scorebox" data-module="${modKey}" data-index="${idx}" data-qid="${escapeAttr(qId)}">
      <option value="">—</option>
      ${options}
    </select>
  `;
}

function getMeta(modKey, idx){
  const module = MODEL.find(m => m.key === modKey);
  const question = module && module.questions ? module.questions[idx] : null;
  const fallback = window.CUR_LANG === "en" ? "(None)" : "（暂无）";
  if(!question){
    return { focus: [fallback], ask: [fallback], evidence: [fallback], threshold: [fallback] };
  }
  const meta = tMeta(question) || {};
  const pick = key => {
    const arr = meta[key];
    return Array.isArray(arr) && arr.length ? arr : [fallback];
  };
  return {
    focus: pick("focus"),
    ask: pick("ask"),
    evidence: pick("evidence"),
    threshold: pick("threshold")
  };
}

function renderHover(meta){
  const lang = window.CUR_LANG === "en" ? "en" : "zh";
  const labels = lang === "en"
    ? { f: "Focus", a: "How to ask", e: "Expected evidence", th: "Suggested thresholds" }
    : { f: "关注点", a: "怎么问", e: "期望证据", th: "建议门槛" };
  const mk = (title, arr) => {
    const items = Array.isArray(arr) ? arr : [arr];
    const lis = items.map(item => `<li>${escapeHtml(item)}</li>`).join("");
    return `<h5>${escapeHtml(title)}</h5><ul>${lis}</ul>`;
  };
  return mk(labels.f, meta.focus) + mk(labels.a, meta.ask) + mk(labels.e, meta.evidence) + mk(labels.th, meta.threshold);
}

function bindHovercard(){
  const card = document.getElementById("hovercard");
  if(!card) return;
  const cells = document.querySelectorAll("td.qtext");
  const hide = () => card.setAttribute("aria-hidden", "true");
  const place = ev => {
    if(!ev) return;
    const pad = 12;
    let x = ev.clientX + pad;
    let y = ev.clientY + pad;
    const rect = card.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    if(x + rect.width > vw - 8) x = Math.max(8, vw - rect.width - 8);
    if(y + rect.height > vh - 8) y = Math.max(8, vh - rect.height - 8);
    card.style.left = `${Math.max(8, x)}px`;
    card.style.top = `${Math.max(8, y)}px`;
  };
  cells.forEach(td => {
    td.addEventListener("mouseenter", ev => {
      const meta = getMeta(td.dataset.module, Number(td.dataset.index));
      card.innerHTML = renderHover(meta);
      card.setAttribute("aria-hidden", "false");
      place(ev);
    });
    td.addEventListener("mousemove", place);
    td.addEventListener("mouseleave", hide);
    td.addEventListener("focus", () => {
      const meta = getMeta(td.dataset.module, Number(td.dataset.index));
      card.innerHTML = renderHover(meta);
      card.setAttribute("aria-hidden", "false");
      const bounds = td.getBoundingClientRect();
      let x = bounds.right + 8;
      let y = bounds.bottom + 8;
      const rect = card.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      if(x + rect.width > vw - 8) x = Math.max(8, vw - rect.width - 8);
      if(y + rect.height > vh - 8) y = Math.max(8, vh - rect.height - 8);
      card.style.left = `${Math.max(8, x)}px`;
      card.style.top = `${Math.max(8, y)}px`;
    });
    td.addEventListener("blur", hide);
  });
  if(!HOVER_EVENTS_BOUND){
    document.addEventListener("keydown", e => { if(e.key === "Escape") hide(); });
    window.addEventListener("scroll", hide, { passive: true });
    window.addEventListener("resize", hide);
    HOVER_EVENTS_BOUND = true;
  }
}

function renderModules(modules){
  const host = document.getElementById("modules");
  if(!host) return;
  const notePlaceholder = escapeAttr(tUI("notes.placeholder"));
  const html = modules.map(module => {
    const questions = (module.questions || []).map((q, idx) => `
      <tr data-module="${module.key}" data-index="${idx}" data-qid="${escapeAttr(q.id)}">
        <td>${idx + 1}</td>
        <td class="qtext" data-module="${module.key}" data-index="${idx}" data-qid="${escapeAttr(q.id)}" tabindex="0">
          <div>${escapeHtml(tText(q))}</div>
        </td>
        <td class="score-cell">
          ${renderScorebox(module.key, idx)}
        </td>
        <td><input class="notes" data-module="${module.key}" data-index="${idx}" data-qid="${escapeAttr(q.id)}" placeholder="${notePlaceholder}"></td>
      </tr>
    `).join("");
    const intentText = tIntent(module);
    const intent = intentText ? `<span class="badge" title="${escapeHtml(intentText)}">${escapeHtml(tUI("badge.intent"))}${escapeHtml(intentText)}</span>` : "";
    return `
      <div class="card module">
        <div class="mod-head">
          <h2>${escapeHtml(tName(module))}</h2>
          ${intent}
        </div>
        <table>
          <thead><tr><th style="width:44px">#</th><th>${escapeHtml(tUI("questions"))}</th><th style="width:110px">${escapeHtml(tUI("score"))}</th><th>${escapeHtml(tUI("notes"))}</th></tr></thead>
          <tbody>${questions}</tbody>
        </table>
        <div class="footer">
          <span class="pill">${escapeHtml(tUI("module.avg"))}<b class="avg" data-module="${module.key}">—</b></span>
          <span class="muted">${escapeHtml(tUI("module.avg.note"))}</span>
        </div>
      </div>
    `;
  }).join("");
  host.innerHTML = html;
  host.querySelectorAll("select.scorebox").forEach(sel => {
    sel.addEventListener("change", () => {
      const value = sel.value ? Number(sel.value) : null;
      saveField(sel.dataset.module, sel.dataset.qid, "score", value);
      recalc();
    });
  });
  host.querySelectorAll("input.notes").forEach(input => {
    input.addEventListener("input", () => {
      saveField(input.dataset.module, input.dataset.qid, "note", input.value);
    });
  });
}

function applyUIStrings(){
  const lang = window.CUR_LANG === "en" ? "en" : "zh";
  document.documentElement.lang = lang === "en" ? "en" : "zh";
  document.title = tUI("title");
  const titleEl = document.getElementById("pageTitle");
  if(titleEl) titleEl.textContent = tUI("title");
  const descEl = document.getElementById("pageDesc");
  if(descEl) descEl.textContent = tUI("desc");
  const clearBtn = document.getElementById("clearBtn");
  if(clearBtn) clearBtn.textContent = tUI("clear");
  const exportBtn = document.getElementById("exportBtn");
  if(exportBtn) exportBtn.textContent = tUI("export");
  const legend = document.getElementById("scaleLegend");
  if(legend) legend.textContent = tUI("legend.scale");
  const summaryTitle = document.getElementById("summaryTitle");
  if(summaryTitle) summaryTitle.textContent = tUI("summary.title");
  const summaryTip = document.getElementById("summaryTip");
  if(summaryTip) summaryTip.innerHTML = tUI("summary.tip");
  const langToggle = document.getElementById("langToggle");
  if(langToggle) langToggle.textContent = tUI("toggle.lang");
}

function updateRadarLabels(){
  if(!radar) return;
  radar.data.labels = MODEL.map(m => tName(m).replace(/^\d+\.\s*/, ""));
  if(radar.data.datasets && radar.data.datasets[0]){
    radar.data.datasets[0].label = tUI("chart.dataset");
  }
  radar.update();
}

const kpiBox = document.getElementById("kpi");

function kpiCell(label, value){
  const numeric = typeof value === "number" && !Number.isNaN(value) && Number.isFinite(value);
  const color = numeric ? (value >= 4 ? "ok" : (value >= 3 ? "warn" : "risk")) : "risk";
  const display = numeric ? value.toFixed(2) : "—";
  return `<div><div class="muted">${escapeHtml(label)}</div><div class="${color}" style="font-size:20px;font-weight:700">${display}</div></div>`;
}

function recalc(){
  if(!Array.isArray(MODEL) || !MODEL.length) return;
  moduleAverages.clear();
  const averages = [];
  MODEL.forEach((module, idx) => {
    const selects = Array.from(document.querySelectorAll(`select.scorebox[data-module="${module.key}"]`));
    const scores = selects.map(sel => Number(sel.value)).filter(v => !Number.isNaN(v) && v > 0);
    const avg = scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : NaN;
    moduleAverages.set(module.key, avg);
    const avgEl = document.querySelector(`.avg[data-module="${module.key}"]`);
    if(avgEl){
      avgEl.textContent = Number.isFinite(avg) ? avg.toFixed(2) : "—";
    }
    averages[idx] = Number.isFinite(avg) ? Number(avg.toFixed(2)) : NaN;
  });
  if(radar){
    radar.data.datasets[0].data = averages.map(v => Number.isFinite(v) ? v : 0);
    radar.update();
  }
  const valid = averages.filter(v => Number.isFinite(v) && v > 0);
  const overall = valid.length ? valid.reduce((sum, v) => sum + v, 0) / valid.length : NaN;
  kpiBox.innerHTML =
    kpiCell(tUI("kpi.overall"), overall) +
    MODEL.map((module, idx) => {
      const label = tName(module).replace(/^\d+\.\s*/, "") || module.key;
      return kpiCell(label, averages[idx]);
    }).join("");
}

function resetScores(){
  document.querySelectorAll("select.scorebox").forEach(sel => sel.value = "");
  document.querySelectorAll("input.notes").forEach(input => input.value = "");
  moduleAverages.clear();
  writeDraft({ lang: window.CUR_LANG || "zh" });
  recalc();
}

function calcAvgForModule(modKey){
  const avg = moduleAverages.get(modKey);
  return (typeof avg === "number" && !Number.isNaN(avg) && Number.isFinite(avg)) ? Number(avg.toFixed(2)) : null;
}

function exportJSON(){
  const output = { generatedAt: new Date().toISOString(), lang: window.CUR_LANG || "zh", modules: [] };
  MODEL.forEach(module => {
    const selects = Array.from(document.querySelectorAll(`select.scorebox[data-module="${module.key}"]`));
    const rows = selects.map(sel => {
      const idx = Number(sel.dataset.index);
      const question = module.questions[idx];
      const tr = sel.closest("tr");
      const noteInput = tr ? tr.querySelector(".notes") : null;
      const note = noteInput ? noteInput.value : "";
      return {
        id: question.id,
        q: tText(question),
        q_all: question.text,
        score: sel.value ? Number(sel.value) : 0,
        note,
        rubric: tRubric(question),
        rubric_all: question.rubric,
        meta: tMeta(question),
        meta_all: question.meta
      };
    });
    output.modules.push({
      key: module.key,
      name: tName(module),
      name_all: module.name,
      version: module.version || null,
      intent: module.intent || null,
      avg: calcAvgForModule(module.key),
      rows
    });
  });
  const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `audit_export_${new Date().toISOString().slice(0, 10)}.json`;
  link.click();
  URL.revokeObjectURL(link.href);
}

async function loadUI(){
  try{
    const res = await fetch(`${DATA_DIR}/i18n-ui.json?ts=${Date.now()}`);
    if(!res.ok){
      throw new Error(`无法加载 UI 文案：${res.status}`);
    }
    UI_I18N = await res.json();
    window.UI_I18N = UI_I18N;
  } catch (err){
    console.warn(err);
    UI_I18N = { zh: {}, en: {} };
    window.UI_I18N = UI_I18N;
  }
}

async function loadModules(){
  const modules = [];
  for(const key of MODULE_KEYS){
    const url = `${DATA_DIR}/${key}.json?ts=${Date.now()}`;
    const response = await fetch(url);
    if(!response.ok){
      throw new Error(`无法加载数据：${key}.json`);
    }
    const data = await response.json();
    const moduleKey = data.key || key;
    data.key = moduleKey;
    data.name = ensureLangObject(data.name);
    if(data.intent !== undefined){
      const intentObj = ensureLangObject(data.intent);
      if(intentObj.zh || intentObj.en){
        data.intent = intentObj;
      } else {
        delete data.intent;
      }
    }
    data.questions = Array.isArray(data.questions)
      ? data.questions.map((q, idx) => ensureQuestionShape(moduleKey, q, idx))
      : [];
    modules.push(data);
  }
  MODEL = modules;
  window.MODEL = MODEL;
  return modules;
}

function initRadar(modules){
  const canvas = document.getElementById("radar");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const labels = modules.map(m => tName(m).replace(/^\d+\.\s*/, ""));
  radar = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: tUI("chart.dataset"),
        data: new Array(labels.length).fill(0),
        fill: true,
        borderWidth: 2,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      scales: { r: { min: 0, max: 5, ticks: { stepSize: 1 } } },
      plugins: { legend: { display: false } }
    }
  });
}

function rerenderAll(){
  const draft = readDraft();
  if(draft.lang && LANGS.includes(draft.lang)){
    window.CUR_LANG = draft.lang;
    setLang(draft.lang);
  }
  applyUIStrings();
  renderModules(MODEL);
  applyDraft(draft);
  bindHovercard();
  updateRadarLabels();
  recalc();
}

function setupLangToggle(){
  const btn = document.getElementById("langToggle");
  if(!btn) return;
  const apply = () => { btn.textContent = tUI("toggle.lang"); };
  btn.addEventListener("click", () => {
    const cur = window.CUR_LANG || "zh";
    const next = cur === "zh" ? "en" : "zh";
    window.CUR_LANG = next;
    setLang(next);
    const draft = readDraft();
    draft.lang = next;
    writeDraft(draft);
    apply();
    rerenderAll();
  });
  apply();
}

function setupActions(){
  const clearBtn = document.getElementById("clearBtn");
  if(clearBtn){
    clearBtn.addEventListener("click", resetScores);
  }
  const exportBtn = document.getElementById("exportBtn");
  if(exportBtn){
    exportBtn.addEventListener("click", exportJSON);
  }
}

(async function init(){
  try{
    await loadUI();
    const draft = readDraft();
    const initialLang = draft.lang && LANGS.includes(draft.lang) ? draft.lang : getLang();
    window.CUR_LANG = initialLang;
    setLang(initialLang);
    setupActions();
    setupLangToggle();
    await loadModules();
    initRadar(MODEL);
    rerenderAll();
  } catch (err){
    console.error(err);
    const host = document.getElementById("modules");
    if(host){
      host.innerHTML = `<div class="card">数据加载失败：${escapeHtml(err && err.message ? err.message : err)}</div>`;
    }
  }
})();
</script>
</body>
</html>
