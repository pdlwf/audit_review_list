<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>R&D Capability Assessment – 研发能力审核（含雷达图）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif;margin:24px;color:#111}
  h1,h2{margin:0 0 12px}
  .desc{color:#555;margin-bottom:18px}
  .grid{display:grid;gap:18px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #eee;padding:10px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  .mod-head{display:flex;justify-content:space-between;align-items:center}
  .badge{background:#eef6ff;color:#0366d6;border:1px solid #cfe3ff;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill{padding:2px 8px;border-radius:8px;background:#f6f6f6;border:1px solid #eaeaea;font-size:12px;color:#444}
  .scorebox{width:64px}
  .notes{width:100%}
  .footer{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .legend{font-size:12px;color:#555}
  .muted{color:#777}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi > div{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;text-align:center}
  .ok{color:#0a7a34}
  .warn{color:#b45309}
  .risk{color:#b91c1c}
  .stickybar{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:10px 0;margin:-10px 0 14px}
  .btn{cursor:pointer;border:1px solid #ddd;background:#fff;border-radius:8px;padding:8px 12px}
  .btn:hover{background:#f6f6f6}
  details.rubric{margin-top:6px;font-size:12px}
  details.rubric summary{cursor:pointer;color:#0366d6}
  details.rubric ul{margin:6px 0 0 18px;padding:0;list-style:disc}
  details.rubric li{margin-bottom:4px}
</style>
</head>
<body>
  <div class="stickybar footer">
    <button class="btn" onclick="resetScores()">清空分数</button>
    <button class="btn" onclick="exportJSON()">导出 JSON</button>
    <span class="legend">评分尺度：1 无系统｜2 非正式｜3 有文件并执行｜4 有效运行且闭环｜5 自动化数据驱动</span>
  </div>

  <h1>研发能力审核 R&D Capability Assessment</h1>
  <p class="desc">目标：确认供应商从产品定义、设计、验证到制造导入全链路内建质量与可靠性，风险受控、供应可得、测试覆盖充分，并以数据驱动持续改进。</p>

  <div id="modules" class="grid"></div>

  <div class="card">
    <h2>汇总与雷达图</h2>
    <div class="kpi" id="kpi"></div>
    <canvas id="radar" height="180"></canvas>
    <p class="muted">提示：各模块得分为该模块问题的<strong>平均分</strong>（满分 5）。建议门槛：<span class="ok">≥4.0</span> 合格；<span class="warn">3.0–3.9</span> 需整改计划；<span class="risk">&lt;3.0</span> 高风险。</p>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
/** 模块与问题定义（根据 revise.md 同步结构与口径） **/
// 从 revise.md 解析口径，并对缺失项按模板补齐评分标准
const MODEL = [
  {
    key:"org",
    name:"1. 研发组织与资源",
    intent:"确认组织健全、职责清晰、胜任力与培训体系完善",
    questions:[
      {
        text:`<strong>#1 组织边界与职责清晰度（R&R、跨团队接口）</strong><br>是否有正式组织架构、跨团队接口定义与升级路径？`,
        rubric:{
          "1":"无正式组织架构或职责描述，跨团队接口依赖个人沟通。",
          "2":"有组织图但R&R模糊，接口人或升级路径缺乏记录。",
          "3":"形成书面R&R并发布，跨团队接口与职责有基本定义。",
          "4":"跨团队接口SLA、升级机制与例会例行执行，职责边界清晰落地。",
          "5":"基于项目复盘动态优化R&R，接口绩效与资源数据化可追踪。"
        }
      },
      {
        text:`<strong>#2 关键岗位胜任力矩阵（RF/Camera/EMC/热/可靠性）</strong><br>关键岗位是否具备胜任力矩阵与资格认证？`,
        rubric:{
          "1":"无胜任力矩阵或岗位胜任标准，人员能力不可视。",
          "2":"有零散胜任力记录但未覆盖关键岗位或缺更新。",
          "3":"建立胜任力矩阵并定义资格标准，具备考核记录。",
          "4":"定期评审矩阵并联动培训/考证，能力缺口有闭环计划。",
          "5":"胜任力矩阵与项目需求/资源排期联动，预警能力缺口并沉淀数据。"
        }
      },
      {
        text:`<strong>#4 领域覆盖与 DRI 清单（子系统命名 DRI、权限）</strong><br>是否维护子系统 DRI 清单及权限边界？`,
        rubric:{
          "1":"无 DRI 清单或仅口头指定，领域覆盖情况不透明。",
          "2":"存在初步 DRI 名单但权限、职责或备份安排不清晰。",
          "3":"维护正式 DRI 清单并定义权限范围，项目可查询到负责人。",
          "4":"DRI 清单与项目/变更动态同步，覆盖缺口及时补位。",
          "5":"DRI 清单与资源看板/排班系统集成，能力负荷与权限变更可追踪。"
        }
      },
      {
        text:`<strong>#5 技术治理与决策边界（DRB/CCB、Stop-Build 建议权）</strong><br>技术治理机制是否有效运行？`,
        rubric:{
          "1":"无技术治理例会或决策机制，重大变更随意决策。",
          "2":"偶尔召开 DRB/CCB，但议题、参与人和结论缺章程。",
          "3":"DRB/CCB 有章程与决策记录，Stop-Build 建议有依据。",
          "4":"技术治理决策与风险、度量挂钩，可触发停线与整改闭环。",
          "5":"技术治理体系数据化运行，决策与指标、知识库形成闭环。"
        }
      }
    ]
  },
  {
    key:"process",
    name:"2. 研发流程与标准（NPI/IPD）",
    intent:"确认端到端流程文件化并与合规/客户标准对齐",
    questions:[
      {
        text:"是否有端到端 NPI 流程（需求→架构→设计→验证→移交），并落实职责分工？",
        rubric:{
          "1":"无端到端 NPI 流程，节点靠经验推进。",
          "2":"有流程框架但未纳入标准里程碑与角色责任。",
          "3":"端到端 NPI 流程已文档化，关键里程碑与交付物有规定。",
          "4":"流程结合跨部门评审与门禁，执行状态有记录与复盘。",
          "5":"流程与项目管理系统集成，指标与风险自动监控。"
        }
      },
      {
        text:"是否建立研发设计规范库（PCB、ESD、射频、结构等）并保持版本可追溯？",
        rubric:{
          "1":"无统一设计规范，依赖个人经验。",
          "2":"有零散规范或旧版本，缺更新机制。",
          "3":"关键领域建立受控的设计规范并发布。",
          "4":"规范定期评审并关联培训/检查表，执行有记录。",
          "5":"规范与工具链/DRC 联动，变更自动通知并追踪执行。"
        }
      },
      {
        text:"对外部输入（客户/法规/PCN）是否建立变更感知与落地机制？",
        rubric:{
          "1":"无外部输入跟踪机制，信息靠个人传达。",
          "2":"能接收外部输入但缺评估与落实记录。",
          "3":"建立外部输入台账并指定责任人跟进落实。",
          "4":"变更评估流程覆盖影响分析与验证计划，闭环可审计。",
          "5":"外部输入与需求/配置系统联动，落地状态可视化与预警。"
        }
      }
    ]
  },
  {
    key:"design",
    name:"3. 设计质量与可靠性（含前期物料选型与准入）",
    intent:"确认设计阶段内建可靠性与可制造性，并以规范与证据闭环",
    questions:[
      {
        text:`【3.1 静电/浪涌与系统级保护（ESD/Surge）】<ul><li>规范：ESD/Surge 设计指南（器件/布局/接地/回流）</li><li>保护：接口 TVS/滤波/共模扼流 BOM（USB-C/SIM/天线/显示/按键）</li><li>预验证：IEC 61000-4-2 目标等级记录；Latch-up/JEDEC 测试</li><li>充电口：OVP/OCP/OTP；带电插拔/EFT 场景</li><li>证据：器件选型表、布局截图、预验证报告</li></ul>`,
        rubric:{
          "1":"无 ESD/Surge 设计规范，依赖个人经验处理接口保护。",
          "2":"有零散 ESD/Surge 经历但缺统一器件 BOM 与记录。",
          "3":"形成 ESD/Surge 规范并完成关键接口预验证与等级记录。",
          "4":"器件、布局、预验证闭环稳定，充电口保护与 Latch-up 测试达标。",
          "5":"自动化 DRC 与器件库维护，变更触发复核并持续跟踪相关性。"
        }
      },
      {
        text:`【3.2 电源完整性与 WCCA（Worst-Case）】<ul><li>稳定性：环路补偿 Bode（相位/增益裕量）</li><li>时序：上/下电时序波形与限制</li><li>容差：关键电源链路 WCCA/器件偏差/温漂/老化</li><li>安全：充电/放电失效注入（短路/探头脱落/冲击）</li><li>证据：电源树、Bode/时序实测、WCCA 报告、失效注入记录</li></ul>`,
        rubric:{
          "1":"无电源稳定性或 WCCA 分析，依赖样机试错。",
          "2":"零散测量缺少 Bode 或容差分析，文档不完整。",
          "3":"具备 Bode 测试并对关键节点进行容差与限值评估。",
          "4":"完成完整 WCCA 报告并覆盖失效注入与充放电安全验证。",
          "5":"电源模型化并与仿真/实测阈值联动，变更自动触发复核。"
        }
      },
      {
        text:`【3.3 PDN / SI-PI 联合仿真】<ul><li>目标：PDN 目标阻抗（频域/时域）</li><li>去耦：电容网络方案与布局回路</li><li>高速：MIPI/USB/DDR 眼图/BER 报告</li><li>一致性：仿真 vs 板上测量对比</li><li>证据：PDN 仿真/测量、眼图、去耦清单</li></ul>`,
        rubric:{
          "1":"无 PDN 目标阻抗或 SI-PI 仿真，去耦方案凭经验。",
          "2":"仅经验摆放电容，缺少量化指标或仿真记录。",
          "3":"制定 PDN 目标并开展仿真与眼图分析。",
          "4":"仿真与板上测量一致，去耦与眼图报告形成闭环。",
          "5":"持续监控版本间相关性，PDN 目标与变更复核联动。"
        }
      },
      {
        text:`【3.4 结构应力 / 冲击 / 密封（FEA & IP）】<ul><li>FEA：跌落/扭转/点载 CAE 与实测闭环</li><li>连接：螺钉/卡扣/胶粘结构强度与疲劳</li><li>IP：密封胶圈压缩量、公差链；透气件布置</li><li>耐蚀：汗液/盐雾风险点</li><li>证据：CAE 模型/校核、跌落&扭转实测、IP 型式测试</li></ul>`,
        rubric:{
          "1":"仅做零散结构实测，无 CAE 或标准支撑。",
          "2":"尚未建立系统 CAE 模型，评估多依赖经验。",
          "3":"能执行 CAE 或实测其一，覆盖主要跌落/扭转/IP 场景。",
          "4":"CAE 与实测互相校验，IP 型式与耐蚀测试达到目标。",
          "5":"建立参数库与公差链分析，结构/密封变更自动触发复核。"
        }
      },
      {
        text:`【3.5 热设计与电-热协同（CFD）】<ul><li>工况：拍摄/5G/游戏/充电 场景功耗</li><li>仿真：稳态+瞬态 CFD；测温点对比</li><li>方案：石墨片/VC/TIM；节流策略曲线</li><li>降额：热致降额与寿命</li><li>证据：CFD 报告、测温表、节流策略</li></ul>`,
        rubric:{
          "1":"无热设计仿真或节流策略，依靠经验排布。",
          "2":"仅有稳态仿真或零散测温，缺少校准基准。",
          "3":"完成稳态仿真并进行关键点测温校核。",
          "4":"稳态与瞬态 CFD 与实测偏差受控，节流与降额策略闭环。",
          "5":"电热耦合模型与寿命评估联动，热点监控与策略自动更新。"
        }
      },
      {
        text:`【3.6 射频/天线仿真与 OTA 预算】<ul><li>EM：3D 天线/整机仿真（FEM/FDTD）</li><li>余量：效率/带宽/匹配容差；MIMO 相关性</li><li>影响：结构件/屏蔽/地弹片变更复核</li><li>合规：SAR 初评</li><li>证据：EM 仿真、VNA/OTA 实测、变更评估单</li></ul>`,
        rubric:{
          "1":"仅关注 S11 等基础匹配，无 OTA 预算或仿真。",
          "2":"零散开展 3D EM 或 OTA 其中一项，缺系统预算。",
          "3":"具备 3D EM 仿真或 OTA 测试，并对效率/匹配进行评估。",
          "4":"EM 与 OTA 数据一致性可证明，余量与结构变更有复核。",
          "5":"建立余量预算与变更触发机制，持续监控 MIMO/SAR 数据闭环。"
        }
      },
      {
        text:`【3.7 条件触发的必要仿真（按 DFMEA 高风险触发）】<ul><li>公差链 Monte-Carlo（贴合/光轴/密封/卡扣）</li><li>相机专项（MTF/SFR、OIS/AF 寿命）</li><li>声学/振动（腔体、Mic、NVH）</li><li>EMC 预分析（谐振/屏蔽/滤波）</li><li>电池模型（循环寿命、极耳温升热点）</li></ul>`,
        rubric:{
          "1":"无条件触发仿真策略，DFMEA 高风险未覆盖。",
          "2":"仅零散执行个别专项仿真，缺触发标准与记录。",
          "3":"依据 DFMEA 触发主要专项仿真，但闭环与验证不完全。",
          "4":"触发条件、仿真与验证闭环形成台账，可追溯至项目风险。",
          "5":"仿真模型与参数库维护完备，与变更/风险阈值联动自动复核。"
        }
      }
    ]
  },
  {
    key:"verify",
    name:"4. 实验验证与测试能力",
    intent:"确认具备研发阶段验证手段与场景覆盖，且与目标/准则闭环",
    questions:[
      {
        text:"是否建立覆盖功能/性能/可靠性/合规的测试矩阵，并与 Entry/Exit 对齐？",
        rubric:{
          "1":"无测试矩阵，测试科目依赖经验安排。",
          "2":"按经验挑选测试科目，矩阵覆盖与门槛未定义。",
          "3":"建立测试矩阵并列出覆盖项，但 Entry/Exit 或判定阈值未完全对齐。",
          "4":"测试矩阵与 Entry/Exit、停线规则对齐，异常有闭环机制。",
          "5":"测试数据回写到规则库，矩阵覆盖率与缺口动态维护。"
        }
      },
      {
        text:"是否具备关键实验室/仪器（EMC/安规/ESD/热像/相机 SFR/射频）或合格外部实验室？",
        rubric:{
          "1":"缺乏关键实验室或仪器，能力无法满足需求。",
          "2":"部分仪器具备但校准或资质缺失，外部资源无评估。",
          "3":"关键实验室或外部资质明确，仪器清单与校准记录可追溯。",
          "4":"仪器能力与维护计划闭环，产能与排期满足项目需求。",
          "5":"实验室能力指标化管理，容量与质量数据驱动资源规划。"
        }
      },
      {
        text:"是否开展环境与寿命测试（ALT/高低温循环/高湿/盐雾/汗液），并建立寿命预测模型？",
        rubric:{
          "1":"无环境或寿命测试计划，风险未识别。",
          "2":"零散开展环境或寿命测试，缺方法与记录。",
          "3":"执行 ALT/高低温/盐雾等测试，并保留数据与判定标准。",
          "4":"建立寿命预测模型，与测试数据比对闭环并形成改进。",
          "5":"寿命模型与量产监控联动，数据驱动策略调整与预警。"
        }
      },
      {
        text:"RF/OTA 暗室是否能完成 TRP/TIS 测试？仿真与实测的相关性如何证明？",
        rubric:{
          "1":"无 OTA 能力或无报告",
          "2":"有测试记录，方法/校准/相关性缺失",
          "3":"可完成 TRP/TIS，相关性有初步对比",
          "4":"方法规范，相关性阈值明确且稳定达标",
          "5":"常态化相关性监控与模型回归；结构变更触发复核"
        }
      },
      {
        text:"相机实验室是否能出具 MTF/SFR、OECF、畸变、杂散光、OIS/AF 寿命完整报告？",
        rubric:{
          "1":"无相机实验能力或无报告",
          "2":"科目零散，缺方法与校准",
          "3":"主要科目可出具，方法/校准基本合规",
          "4":"全科目覆盖，数据可追溯、稳定复现",
          "5":"与量产 ORT/场景数据闭环（趋势/漂移监控与规则回写）"
        }
      }
    ]
  },
  {
    key:"scm",
    name:"5. 研发与供应链协同（DFM/DFA/早期导入）",
    intent:"确认设计阶段即考虑可制造性、可装配性与可得性，二供与工装同步",
    questions:[
      {
        text:"是否进行跨部门 DFM/DFA 评审（RD/ME/PE/QA/SCM），并确保结论整改闭环？",
        rubric:{
          "1":"未开展跨部门 DFM/DFA 评审，设计制造冲突未识别。",
          "2":"偶尔召开评审但参会部门不全，整改缺乏记录。",
          "3":"建立跨部门评审并形成整改清单，部分闭环。",
          "4":"评审结论按责任闭环并追踪验证，工艺约束纳入设计基线。",
          "5":"DFM/DFA 评审数据化沉淀，问题趋势与经验库驱动设计优化。"
        }
      },
      {
        text:"早期供应商参与（ESI）：产能/交期/生命周期/替代评估是否纳入设计约束？",
        rubric:{
          "1":"无早期供应商参与，设计阶段缺供方输入。",
          "2":"仅在样机阶段邀请供应商，产能或交期评估缺失。",
          "3":"制定 ESI 计划，涵盖产能、交期与生命周期评估。",
          "4":"供应商评估结果纳入设计约束，措施闭环并有记录。",
          "5":"ESI 数据与项目计划联动，供应能力变化实时预警。"
        }
      },
      {
        text:"关键物料二供策略是否在设计阶段完成等效性验证（功能/可靠性/一致性）？",
        rubric:{
          "1":"无二供策略或仅口头约定。",
          "2":"识别潜在二供但未验证等效性。",
          "3":"关键物料二供完成功能验证并记录。",
          "4":"二供验证覆盖可靠性与一致性，切换流程明确。",
          "5":"二供能力纳入风险矩阵，量产状态持续监控与回写。"
        }
      },
      {
        text:"试产前工装/治具/ICT/FCT 需求与验收标准是否明确并完成验收？",
        rubric:{
          "1":"试产前工装/治具需求未识别或无标准。",
          "2":"有工装需求但验收标准缺失，交付常延误。",
          "3":"工装/ICT/FCT 需求明确定义并完成基本验收。",
          "4":"验收标准量化且闭环，试产前完成调试与培训。",
          "5":"工装状态数字化管理，与试产/量产良率数据联动。"
        }
      }
    ]
  },
  {
    key:"change",
    name:"6. 变更与配置管理（ECN/BOM/版本）",
    intent:"确认研发变更受控、版本与样机/批次可双向追溯",
    questions:[
      {
        text:"需求/设计变更是否执行 ECR→ECN 流程并进行成本/进度/质量影响评估？",
        rubric:{
          "1":"无正式 ECR/ECN 流程，变更记录缺失。",
          "2":"有流程但执行零散，影响评估模板不完整。",
          "3":"ECR→ECN 流程运行，影响评估与审批记录完整。",
          "4":"评估结论与验证计划闭环，实施状态可追溯。",
          "5":"变更流程与项目系统集成，影响数据实时分析与预警。"
        }
      },
      {
        text:"BOM/图纸/固件是否在 PLM/ALM 中实现单一数据源与权限控制？",
        rubric:{
          "1":"BOM/图纸/固件分散管理，缺乏权限控制。",
          "2":"部分资料入库但版本控制不一致。",
          "3":"在 PLM/ALM 中维护单一数据源并设定权限。",
          "4":"版本更替有审批轨迹，与制造/供应链同步。",
          "5":"数据主线与配置管理系统打通，自动同步并可审计。"
        }
      },
      {
        text:"样机/批次与版本是否可双向追溯（Where Used/As-built）？",
        rubric:{
          "1":"样机或批次无法追溯所用版本。",
          "2":"存在零散追溯记录，查询效率低。",
          "3":"建立双向追溯台账，可关联主要样机与版本。",
          "4":"追溯信息实时更新，支持快速定位影响范围。",
          "5":"追溯系统可视化，支持逆向分析与批量预警。"
        }
      },
      {
        text:"对客户/生产/供应商的 PCN/SCN 通知机制是否明确且可审计？",
        rubric:{
          "1":"无 PCN/SCN 通知机制，沟通多靠口头。",
          "2":"有通知流程但责任与时限不明确。",
          "3":"建立通知流程与记录，能对关键方进行确认。",
          "4":"通知包含影响评估与应对计划，全链路可追溯。",
          "5":"通知流程数字化，与供应商/客户系统对接并自动提醒。"
        }
      }
    ]
  },
  {
    key:"risk",
    name:"7. 风险管控（技术/进度/合规）",
    intent:"确认从立项起持续识别、量化并处置风险，设置缓冲与熔断机制",
    questions:[
      {
        text:"是否建立项目风险台账（技术/供应/合规/资源），并对风险进行 Impact×Probability 量化？",
        rubric:{
          "1":"无项目风险台账，风险靠经验沟通。",
          "2":"有风险清单但未量化 Impact×Probability。",
          "3":"建立风险台账并量化 Impact×Probability，指定责任人。",
          "4":"风险状态定期更新，缓解计划执行可追溯。",
          "5":"风险台账与项目指标联动，支持预警与决策。"
        }
      },
      {
        text:"是否为关键风险建立 Plan B/C（替代方案/降级策略/二供切换）并有演练记录？",
        rubric:{
          "1":"无应急或替代方案。",
          "2":"有口头 Plan B/C，但无演练与记录。",
          "3":"关键风险制定 Plan B/C 并形成文档。",
          "4":"替代方案有演练与资源准备，切换标准明确。",
          "5":"Plan B/C 与监控指标联动，可快速触发并复盘优化。"
        }
      }
    ]
  },
  {
    key:"perf",
    name:"8. 研发绩效与持续改进",
    intent:"确认以数据驱动提升效率与质量，客户反馈闭环到设计",
    questions:[
      {
        text:"是否设定并跟踪研发 KPI（一期通过率/缺陷密度/按期率/返工率/RMA/ppm）？",
        rubric:{
          "1":"无研发 KPI 或仅口头关注。",
          "2":"有 KPI 指标但数据收集不完整。",
          "3":"KPI 定期统计并通报，用于项目评估。",
          "4":"KPI 结合目标对比与根因分析，推动改进。",
          "5":"KPI 数据实时可视化，与激励/改进机制闭环。"
        }
      },
      {
        text:"是否开展项目复盘/LL（Lessons Learned）并沉淀为设计与工艺标准？",
        rubric:{
          "1":"无项目复盘或经验沉淀机制。",
          "2":"零散复盘，输出未标准化。",
          "3":"定期开展复盘并形成 Lessons Learned 文档。",
          "4":"复盘结论转化为规范/检查表并跟踪落实。",
          "5":"LL 库与项目流程结合，自动提醒复用并衡量成效。"
        }
      }
    ]
  }
];


/** 动态渲染清单 **/
const host = document.getElementById('modules');
MODEL.forEach((m, mi) => {
  const card = document.createElement('div');
  card.className='card';
  card.innerHTML = `
    <div class="mod-head">
      <h2>${m.name}</h2>
      <span class="badge" title="${m.intent}">目的：${m.intent}</span>
    </div>
    <table>
      <thead><tr><th style="width:44px">#</th><th>问题（Questions）</th><th style="width:110px">得分(1-5)</th><th>证据/备注</th></tr></thead>
      <tbody>
        ${m.questions.map((q, qi) => `
          <tr>
            <td>${qi+1}</td>
            <td>
              <div>${q.text}</div>
              <details class="rubric"><summary>查看打分口径</summary>
                <ul>
                  ${['1','2','3','4','5'].map(level => `<li><b>${level}分：</b>${q.rubric[level]}</li>`).join('')}
                </ul>
              </details>
            </td>
            <td>
              <select class="scorebox" data-module="${m.key}" onchange="recalc()">
                <option value="">—</option>
                <option value="1">1 无系统</option>
                <option value="2">2 非正式</option>
                <option value="3">3 有文件并执行</option>
                <option value="4">4 有效运行且闭环</option>
                <option value="5">5 自动化数据驱动</option>
              </select>
            </td>
            <td><input class="notes" placeholder="证据/链接/记录编号（如：DFMEA#2025-03, DRR纪要, TVS选型表 等）"/></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div class="footer">
      <span class="pill">模块均分：<b id="avg-${m.key}">—</b></span>
      <span class="muted">（空白项不计入均分）</span>
    </div>
  `;
  host.appendChild(card);
});

/** 汇总与雷达图 **/
const kpiBox = document.getElementById('kpi');
function kpiCell(lbl, val){
  const color = (val>=4)?'ok':(val>=3?'warn':'risk');
  return `<div><div class="muted">${lbl}</div><div class="${color}" style="font-size:20px;font-weight:700">${isNaN(val)?'—':val.toFixed(2)}</div></div>`;
}

const ctx = document.getElementById('radar').getContext('2d');
const radar = new Chart(ctx,{
  type:'radar',
  data:{
    labels: MODEL.map(m=>m.name.replace(/^\d+\.\s*/,'')),
    datasets:[{
      label:'模块得分',
      data: new Array(MODEL.length).fill(0),
      fill:true,
      borderWidth:2,
      pointRadius:3
    }]
  },
  options:{
    responsive:true,
    scales:{ r:{ min:0, max:5, ticks:{stepSize:1} } },
    plugins:{ legend:{display:false} }
  }
});

function recalc(){
  const avgs=[];
  MODEL.forEach((m, idx)=>{
    const selects=[...document.querySelectorAll(`select[data-module="${m.key}"]`)];
    const nums=selects.map(s=>Number(s.value)).filter(v=>!isNaN(v) && v>0);
    const avg = nums.length? nums.reduce((a,b)=>a+b,0)/nums.length : NaN;
    document.getElementById(`avg-${m.key}`).textContent = isNaN(avg)?'—':avg.toFixed(2);
    avgs[idx]= isNaN(avg)? 0 : Number(avg.toFixed(2));
  });
  // 更新雷达
  radar.data.datasets[0].data = avgs.map(v=>v||0);
  radar.update();

  // KPI 概览
  const overall = avgs.filter(v=>v>0).length? (avgs.reduce((a,b)=>a+b,0)/avgs.filter(v=>v>0).length) : NaN;
  kpiBox.innerHTML = 
    kpiCell('总体均分', overall) +
    MODEL.map((m,i)=>kpiCell(m.name.split(' ')[0], avgs[i]||NaN)).join('');
}
recalc();

function resetScores(){
  document.querySelectorAll('select.scorebox').forEach(s=>s.value="");
  document.querySelectorAll('input.notes').forEach(n=>n.value="");
  recalc();
}
function exportJSON(){
  const payload = { modules: [] };
  MODEL.forEach(m=>{
    // 导出时同步题目文本与逐级打分口径，确保数据闭环
    const rows=[...document.querySelectorAll(`select[data-module="${m.key}"]`)].map((s,idx)=>{
      const tr = s.closest('tr');
      const qObj = m.questions[idx];
      return {
        q: qObj.text,
        score: Number(s.value||0),
        note: tr.querySelector('input.notes').value||"",
        rubric: {...qObj.rubric}
      };
    });
    const scores=rows.map(r=>r.score).filter(v=>v>0);
    const avg = scores.length? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
    payload.modules.push({ key:m.key, name:m.name, intent:m.intent, avg: Number(avg.toFixed(2)), rows });
  });
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "rd_capability_assessment.json";
  a.click();
}
</script>
</body>
</html>
