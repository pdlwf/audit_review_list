<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>R&D Capability Assessment – 研发能力审核（含雷达图）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif;margin:24px;color:#111}
  h1,h2{margin:0 0 12px}
  .desc{color:#555;margin-bottom:18px}
  .grid{display:grid;gap:18px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #eee;padding:10px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  .mod-head{display:flex;justify-content:space-between;align-items:center}
  .badge{background:#eef6ff;color:#0366d6;border:1px solid #cfe3ff;padding:2px 8px;border-radius:999px;font-size:12px}
  .pill{padding:2px 8px;border-radius:8px;background:#f6f6f6;border:1px solid #eaeaea;font-size:12px;color:#444}
  select.scorebox{min-width:280px}
  .notes{width:100%}
  .footer{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .legend{font-size:12px;color:#555}
  .muted{color:#777}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi > div{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;text-align:center}
  .ok{color:#0a7a34}
  .warn{color:#b45309}
  .risk{color:#b91c1c}
  .stickybar{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:10px 0;margin:-10px 0 14px}
  .btn{cursor:pointer;border:1px solid #ddd;background:#fff;border-radius:8px;padding:8px 12px}
  .btn:hover{background:#f6f6f6}
  #hovercard{position:fixed;z-index:9999;max-width:420px;background:#111;color:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px 14px;font-size:13px;line-height:1.5;display:none}
  #hovercard h5{margin:6px 0 4px;font-size:12px;color:#a7c7ff}
  #hovercard ul{margin:0 0 6px 16px;padding:0}
  #hovercard[aria-hidden="false"]{display:block}
</style>
</head>
<body>
  <div class="stickybar footer">
    <button class="btn" onclick="resetScores()">清空分数</button>
    <button class="btn" onclick="exportJSON()">导出 JSON</button>
    <span class="legend">评分尺度：1 无系统｜2 非正式｜3 有文件并执行｜4 有效运行且闭环｜5 自动化数据驱动</span>
  </div>

  <h1>研发能力审核 R&D Capability Assessment</h1>
  <p class="desc">目标：确认供应商从产品定义、设计、验证到制造导入全链路内建质量与可靠性，风险受控、供应可得、测试覆盖充分，并以数据驱动持续改进。</p>

  <div id="modules" class="grid"></div>

  <div id="hovercard" role="tooltip" aria-hidden="true"></div>

  <div class="card">
    <h2>汇总与雷达图</h2>
    <div class="kpi" id="kpi"></div>
    <canvas id="radar" height="180"></canvas>
    <p class="muted">提示：各模块得分为该模块问题的<strong>平均分</strong>（满分 5）。建议门槛：<span class="ok">≥4.0</span> 合格；<span class="warn">3.0–3.9</span> 需整改计划；<span class="risk">&lt;3.0</span> 高风险。</p>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
const MODULE_KEYS = ["org","process","design","verify","scm","change","risk","perf"];
const DATA_DIR = "./data";
const moduleAverages = new Map();
let MODEL = [];
let radar = null;

function escapeHtml(str) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
  return String(str ?? '').replace(/[&<>"']/g, ch => map[ch]);
}

function slugify(s){
  return String(s || "")
    .replace(/<\/?[^>]+>/g, "")
    .replace(/[^\w\u4e00-\u9fa5]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-|-$|_/g, "")
    .toLowerCase();
}

function ensureQuestionShape(modKey, q, idx){
  const FALLBACK_RUBRIC = {
    "1":"无系统",
    "2":"非正式",
    "3":"有文件并执行",
    "4":"有效运行且闭环",
    "5":"自动化数据驱动"
  };
  const question = (q && typeof q === "object") ? {...q} : { text: String(q ?? "") };
  question.text = typeof question.text === "string" ? question.text.trim() : String(question.text ?? "");
  if(!question.id || typeof question.id !== "string" || !question.id.trim()){
    const base = slugify(question.text).slice(0, 60) || `q${(idx || 0) + 1}`;
    question.id = `${modKey}-${base}`;
  }
  const rubricSource = (question.rubric && typeof question.rubric === "object") ? question.rubric : {};
  question.rubric = {};
  ["1","2","3","4","5"].forEach(level => {
    const txt = rubricSource[level];
    question.rubric[level] = (txt && String(txt).trim()) ? String(txt).trim() : FALLBACK_RUBRIC[level];
  });
  const metaSource = (question.meta && typeof question.meta === "object") ? question.meta : {};
  const meta = { focus: [], ask: [], evidence: [], threshold: [] };
  Object.keys(meta).forEach(key => {
    const arr = Array.isArray(metaSource[key]) ? metaSource[key] : [];
    const cleaned = arr
      .map(item => (typeof item === "string" ? item.trim() : item))
      .filter(item => item && item !== "（暂无条目）");
    meta[key] = cleaned.length ? Array.from(new Set(cleaned)) : ["（暂无条目）"];
  });
  question.meta = meta;
  return question;
}

function optionHtml(n, text){
  const FALLBACK = {
    1: "1 无系统",
    2: "2 非正式",
    3: "3 有文件并执行",
    4: "4 有效运行且闭环",
    5: "5 自动化数据驱动"
  };
  const raw = text ? `${n} ${text}` : FALLBACK[n];
  const safe = escapeHtml(raw);
  return `<option value="${n}" title="${safe}">${safe}</option>`;
}

function renderScorebox(modKey, qIndex){
  const module = MODEL.find(m => m.key === modKey);
  const question = module && module.questions ? module.questions[qIndex] : null;
  const rubric = question ? question.rubric : null;
  const options = [1,2,3,4,5].map(n => optionHtml(n, rubric ? rubric[String(n)] : null)).join("");
  return `
    <select class="scorebox" data-module="${modKey}" data-index="${qIndex}" onchange="recalc()">
      <option value="">—</option>
      ${options}
    </select>
  `;
}

function getMeta(modKey, idx){
  const module = MODEL.find(m => m.key === modKey);
  const question = module && module.questions ? module.questions[idx] : null;
  if(!question){
    return { focus:["（暂无）"], ask:["（暂无）"], evidence:["（暂无）"], threshold:["（暂无）"] };
  }
  const meta = question.meta || {};
  const pick = key => {
    const arr = Array.isArray(meta[key]) ? meta[key] : [];
    return arr.length ? arr : ["（暂无）"];
  };
  return {
    focus: pick("focus"),
    ask: pick("ask"),
    evidence: pick("evidence"),
    threshold: pick("threshold")
  };
}

function renderHover(meta){
  const sections = [
    ["关注点", meta.focus],
    ["怎么问", meta.ask],
    ["期望证据", meta.evidence],
    ["建议门槛", meta.threshold]
  ];
  return sections.map(([title, list]) => {
    const items = Array.isArray(list) ? list : [list];
    const li = items.map(item => `<li>${escapeHtml(item)}</li>`).join("");
    return `<h5>${escapeHtml(title)}</h5><ul>${li}</ul>`;
  }).join("");
}

function bindHovercard(){
  const card = document.getElementById("hovercard");
  if(!card) return;
  const cells = document.querySelectorAll("td.qtext");
  const hide = () => card.setAttribute("aria-hidden", "true");
  const place = ev => {
    if(!ev) return;
    const pad = 12;
    let x = ev.clientX + pad;
    let y = ev.clientY + pad;
    const rect = card.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    if(x + rect.width > vw - 8) x = Math.max(8, vw - rect.width - 8);
    if(y + rect.height > vh - 8) y = Math.max(8, vh - rect.height - 8);
    card.style.left = `${Math.max(8, x)}px`;
    card.style.top = `${Math.max(8, y)}px`;
  };
  cells.forEach(td => {
    td.addEventListener("mouseenter", ev => {
      const meta = getMeta(td.dataset.module, Number(td.dataset.index));
      card.innerHTML = renderHover(meta);
      card.setAttribute("aria-hidden", "false");
      place(ev);
    });
    td.addEventListener("mousemove", place);
    td.addEventListener("mouseleave", hide);
    td.addEventListener("focus", () => {
      const meta = getMeta(td.dataset.module, Number(td.dataset.index));
      card.innerHTML = renderHover(meta);
      card.setAttribute("aria-hidden", "false");
      const bounds = td.getBoundingClientRect();
      let x = bounds.right + 8;
      let y = bounds.bottom + 8;
      const rect = card.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      if(x + rect.width > vw - 8) x = Math.max(8, vw - rect.width - 8);
      if(y + rect.height > vh - 8) y = Math.max(8, vh - rect.height - 8);
      card.style.left = `${Math.max(8, x)}px`;
      card.style.top = `${Math.max(8, y)}px`;
    });
    td.addEventListener("blur", hide);
  });
  document.addEventListener("keydown", e => { if(e.key === "Escape") hide(); });
  window.addEventListener("scroll", hide, { passive: true });
  window.addEventListener("resize", hide);
}

function renderModules(modules){
  const host = document.getElementById("modules");
  if(!host) return;
  const html = modules.map(module => {
    const questions = (module.questions || []).map((q, idx) => `
      <tr>
        <td>${idx + 1}</td>
        <td class="qtext" data-module="${module.key}" data-index="${idx}" tabindex="0">
          <div>${escapeHtml(q.text)}</div>
        </td>
        <td class="score-cell">
          ${renderScorebox(module.key, idx)}
        </td>
        <td><input class="notes" placeholder="证据/链接/记录编号（如：DFMEA#2025-03, DRR纪要, TVS选型表 等）"></td>
      </tr>
    `).join("");
    const intent = module.intent ? `<span class="badge" title="${escapeHtml(module.intent)}">目的：${escapeHtml(module.intent)}</span>` : "";
    return `
      <div class="card module">
        <div class="mod-head">
          <h2>${escapeHtml(module.name || module.key)}</h2>
          ${intent}
        </div>
        <table>
          <thead><tr><th style="width:44px">#</th><th>问题（Questions）</th><th style="width:110px">得分(1-5)</th><th>证据/备注</th></tr></thead>
          <tbody>${questions}</tbody>
        </table>
        <div class="footer">
          <span class="pill">模块均分：<b class="avg" data-module="${module.key}">—</b></span>
          <span class="muted">（空白项不计入均分）</span>
        </div>
      </div>
    `;
  }).join("");
  host.innerHTML = html;
  host.querySelectorAll('details.rubric').forEach(el => el.remove());
  bindHovercard();
  moduleAverages.clear();
}

const kpiBox = document.getElementById("kpi");

function kpiCell(label, value){
  const numeric = typeof value === "number" && !Number.isNaN(value) && Number.isFinite(value);
  const color = numeric ? (value >= 4 ? "ok" : (value >= 3 ? "warn" : "risk")) : "risk";
  const display = numeric ? value.toFixed(2) : "—";
  return `<div><div class="muted">${escapeHtml(label)}</div><div class="${color}" style="font-size:20px;font-weight:700">${display}</div></div>`;
}

function recalc(){
  if(!Array.isArray(MODEL) || !MODEL.length) return;
  const averages = [];
  MODEL.forEach((module, idx) => {
    const selects = Array.from(document.querySelectorAll(`select.scorebox[data-module="${module.key}"]`));
    const scores = selects.map(sel => Number(sel.value)).filter(v => !Number.isNaN(v) && v > 0);
    const avg = scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : NaN;
    moduleAverages.set(module.key, avg);
    const avgEl = document.querySelector(`.avg[data-module="${module.key}"]`);
    if(avgEl){
      avgEl.textContent = Number.isFinite(avg) ? avg.toFixed(2) : "—";
    }
    averages[idx] = Number.isFinite(avg) ? Number(avg.toFixed(2)) : NaN;
  });
  if(radar){
    radar.data.datasets[0].data = averages.map(v => Number.isFinite(v) ? v : 0);
    radar.update();
  }
  const valid = averages.filter(v => Number.isFinite(v) && v > 0);
  const overall = valid.length ? valid.reduce((sum, v) => sum + v, 0) / valid.length : NaN;
  kpiBox.innerHTML =
    kpiCell("总体均分", overall) +
    MODEL.map((module, idx) => {
      const label = module.name ? module.name.split(" ")[0] : module.key;
      return kpiCell(label, averages[idx]);
    }).join("");
}

function resetScores(){
  document.querySelectorAll("select.scorebox").forEach(sel => sel.value = "");
  document.querySelectorAll("input.notes").forEach(input => input.value = "");
  moduleAverages.clear();
  recalc();
}

function calcAvgForModule(modKey){
  const avg = moduleAverages.get(modKey);
  return (typeof avg === "number" && !Number.isNaN(avg) && Number.isFinite(avg)) ? Number(avg.toFixed(2)) : null;
}

function exportJSON(){
  const output = { generatedAt: new Date().toISOString(), modules: [] };
  MODEL.forEach(module => {
    const selects = Array.from(document.querySelectorAll(`select.scorebox[data-module="${module.key}"]`));
    const rows = selects.map(sel => {
      const idx = Number(sel.dataset.index);
      const question = module.questions[idx];
      const tr = sel.closest("tr");
      const note = tr ? (tr.querySelector(".notes")?.value || "") : "";
      return {
        id: question.id,
        text: question.text,
        score: Number(sel.value || 0),
        note,
        rubric: question.rubric,
        meta: question.meta
      };
    });
    output.modules.push({
      key: module.key,
      name: module.name,
      version: module.version || null,
      avg: calcAvgForModule(module.key),
      rows
    });
  });
  const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `audit_export_${new Date().toISOString().slice(0, 10)}.json`;
  link.click();
  URL.revokeObjectURL(link.href);
}

async function loadModules(){
  const modules = [];
  for(const key of MODULE_KEYS){
    const url = `${DATA_DIR}/${key}.json?ts=${Date.now()}`;
    const response = await fetch(url);
    if(!response.ok){
      throw new Error(`无法加载数据：${key}.json`);
    }
    const data = await response.json();
    const moduleKey = data.key || key;
    data.key = moduleKey;
    data.questions = Array.isArray(data.questions)
      ? data.questions.map((q, idx) => ensureQuestionShape(moduleKey, q, idx))
      : [];
    modules.push(data);
  }
  MODEL = modules;
  window.MODEL = MODEL;
  return modules;
}

function initRadar(modules){
  const canvas = document.getElementById("radar");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const labels = modules.map(m => (m.name || m.key).replace(/^\d+\.\s*/, ""));
  radar = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "模块得分",
        data: new Array(labels.length).fill(0),
        fill: true,
        borderWidth: 2,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      scales: { r: { min: 0, max: 5, ticks: { stepSize: 1 } } },
      plugins: { legend: { display: false } }
    }
  });
}

(async function init(){
  try{
    const modules = await loadModules();
    renderModules(modules);
    initRadar(modules);
    recalc();
  } catch (err){
    console.error(err);
    const host = document.getElementById("modules");
    if(host){
      host.innerHTML = `<div class="card">数据加载失败：${escapeHtml(err && err.message ? err.message : err)}</div>`;
    }
  }
})();
</script>
</body>
</html>
